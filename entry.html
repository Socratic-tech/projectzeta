<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        .score-btn { transition: all 0.2s ease; }
    </style>
</head>

<body class="bg-slate-100 text-slate-900 font-sans pb-20">

<!-- NAV -->
<nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-3xl mx-auto px-4">
        <div class="flex justify-between h-16 items-center">

            <div class="flex items-center gap-2">
                <span class="material-icons text-yellow-400">assignment</span>
                <span class="font-bold text-lg tracking-tight">Vocational Entry</span>
            </div>

            <div class="flex gap-3">
                <a href="setup.html" class="text-blue-200 hover:text-white">
                    <span class="material-icons">settings</span>
                </a>

                <a href="admin.html"
                   class="bg-blue-800 hover:bg-blue-700 px-3 py-1 rounded text-xs font-bold uppercase tracking-wide">
                    Admin
                </a>
            </div>

        </div>
    </div>
</nav>

<!-- MAIN FORM -->
<div class="max-w-3xl mx-auto px-4 py-6">

    <form id="entryForm" onsubmit="submitEntry(event)" class="space-y-6">

        <!-- STUDENT / SITE / DATE -->
        <div class="bg-white p-5 rounded-xl shadow-sm border">

            <h2 class="text-lg font-bold mb-4 border-b pb-2 flex items-center gap-2">
                <span class="material-icons text-blue-600">person</span>
                Student Details
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <div>
                    <label class="text-xs font-bold uppercase mb-1 block text-slate-500">Student</label>
                    <select id="studentSelect" required class="w-full p-3 border rounded-lg bg-slate-50">
                        <option>Loading…</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold uppercase mb-1 block text-slate-500">Job Site</label>
                    <select id="siteSelect" required class="w-full p-3 border rounded-lg bg-slate-50">
                        <option>Loading…</option>
                    </select>
                </div>

            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">

                <div>
                    <label class="text-xs font-bold uppercase mb-1 block text-slate-500">Date</label>
                    <input type="date" id="dateInput" required class="w-full p-3 border rounded-lg bg-slate-50">
                </div>

                <div>
                    <label class="text-xs font-bold uppercase mb-1 block text-slate-500">Evaluator</label>
                    <input type="text" id="evaluatorInput" placeholder="Your Name"
                           required class="w-full p-3 border rounded-lg bg-slate-50">
                </div>

            </div>

        </div>

        <!-- SCORING KEY -->
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <h3 class="text-xs font-bold uppercase text-blue-800 mb-3 text-center">Scoring Key</h3>

            <div class="grid grid-cols-5 gap-1 text-center text-[10px]">
                <div><span class="font-bold text-red-500">0</span><div>Refusal</div></div>
                <div><span class="font-bold text-orange-500">1</span><div>Physical</div></div>
                <div><span class="font-bold text-yellow-600">2</span><div>Model</div></div>
                <div><span class="font-bold text-blue-500">3</span><div>Verbal</div></div>
                <div><span class="font-bold text-green-600">4</span><div>Indep.</div></div>
            </div>
        </div>

        <!-- SKILLS -->
        <div class="bg-white p-5 rounded-xl shadow-sm border">

            <h2 class="text-lg font-bold mb-6 border-b pb-2 flex items-center gap-2">
                <span class="material-icons text-purple-600">psychology</span>
                Skills Assessment
            </h2>

            <div id="skillsContainer" class="space-y-6"></div>

        </div>

        <!-- NOTES -->
        <div class="bg-white p-5 rounded-xl shadow-sm border">

            <h2 class="text-lg font-bold mb-4 border-b pb-2 flex items-center gap-2">
                <span class="material-icons text-slate-600">note</span>
                Notes
            </h2>

            <textarea id="commentsInput" rows="3"
                      placeholder="Specific details about today's performance..."
                      class="w-full p-3 border rounded-lg bg-slate-50"></textarea>
        </div>

        <button type="submit" id="submitBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl 
                       shadow-lg transition flex justify-center items-center gap-2 text-lg">
            <span class="material-icons">send</span>
            SUBMIT ENTRY
        </button>

    </form>
</div>

<script>
/************************************************************
 * CONSTANTS + STATE
 ************************************************************/

const SKILLS_LIST = [
    "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
    "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
    "Demonstrates adaptability", "Work is completed to quality standards",
    "Maintains clean and organized work space", "Awareness of surroundings and good decision making",
    "Appropriate and respectful social interactions", "Displays effective communication skills",
    "Accepts constructive criticism", "Demonstrates a positive attitude",
    "Asks for help appropriately", "Demonstrates self-reflection"
];

const SCORE_STYLES = {
    0: "bg-red-500 text-white border-red-600",
    1: "bg-orange-500 text-white border-orange-600",
    2: "bg-yellow-500 text-white border-yellow-600",
    3: "bg-blue-500 text-white border-blue-600",
    4: "bg-green-600 text-white border-green-700"
};

const INACTIVE = "bg-slate-50 text-slate-400 border-slate-200";
let skillScores = {};

const API_URL = localStorage.getItem("vocational_backend_url");

/************************************************************
 * INIT PAGE
 ************************************************************/
window.onload = () => {
    document.getElementById("dateInput").valueAsDate = new Date();
    renderSkills();
    loadDropdowns();
};

/************************************************************
 * BUILD SKILL BUTTONS
 ************************************************************/
function renderSkills() {
    const container = document.getElementById("skillsContainer");
    container.innerHTML = "";

    SKILLS_LIST.forEach((skill, idx) => {
        skillScores[idx] = 4; // default

        let html = `
            <div>
                <label class="block text-sm font-bold mb-2">${skill}</label>
                <div class="grid grid-cols-5 gap-2">
        `;

        for (let i = 0; i <= 4; i++) {
            html += `
                <button type="button"
                        id="btn_${idx}_${i}"
                        onclick="setScore(${idx}, ${i})"
                        class="score-btn py-3 rounded-lg border font-bold text-lg shadow-sm">
                    ${i}
                </button>
            `;
        }

        html += "</div></div>";
        container.innerHTML += html;
    });

    updateAllButtons();
}

function updateAllButtons() {
    SKILLS_LIST.forEach((_, idx) => updateButtons(idx));
}

function setScore(idx, score) {
    skillScores[idx] = score;
    updateButtons(idx);
}

function updateButtons(idx) {
    const selected = skillScores[idx];

    for (let i = 0; i <= 4; i++) {
        const btn = document.getElementById(`btn_${idx}_${i}`);

        btn.className =
            (i === selected)
                ? `score-btn py-3 rounded-lg border font-bold text-lg shadow-md ${SCORE_STYLES[i]}`
                : `score-btn py-3 rounded-lg border font-bold text-lg shadow-sm ${INACTIVE}`;
    }
}

/************************************************************
 * LOAD STUDENTS + SITES
 ************************************************************/
async function loadDropdowns() {
    if (!API_URL) {
        alert("Database not configured");
        return;
    }

    try {
        const sRes = await fetch(API_URL + "?action=getStudents");
        const sJson = await sRes.json();

        const studentSel = document.getElementById("studentSelect");
        studentSel.innerHTML = `<option value="">Select Student…</option>`;

        sJson.data.forEach(s => {
            studentSel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
        });

        const jRes = await fetch(API_URL + "?action=getSites");
        const jJson = await jRes.json();

        const siteSel = document.getElementById("siteSelect");
        siteSel.innerHTML = `<option value="">Select Site…</option>`;

        jJson.data.forEach(site => {
            siteSel.innerHTML += `<option value="${site}">${site}</option>`;
        });

    } catch (err) {
        console.error("Dropdown load error:", err);
        alert("Failed to load students or sites.");
    }
}

/************************************************************
 * SUBMIT ENTRY
 ************************************************************/
async function submitEntry(e) {
    e.preventDefault();

    const btn = document.getElementById("submitBtn");
    const original = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = `<span class="material-icons animate-spin">refresh</span> Saving…`;

    const payload = {
        action: "addEntry",
        student_id: document.getElementById("studentSelect").value,
        job_site: document.getElementById("siteSelect").value,
        date: document.getElementById("dateInput").value,
        evaluator: document.getElementById("evaluatorInput").value,
        comments: document.getElementById("commentsInput").value,
        scores: {}
    };

    SKILLS_LIST.forEach((skill, idx) => {
        payload.scores[skill] = skillScores[idx];
    });

    try {
        await fetch(API_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain" }, // GAS-friendly
            body: JSON.stringify(payload)
        });

        btn.innerHTML = `<span class="material-icons">check_circle</span> Saved!`;
        btn.classList.replace("bg-blue-600", "bg-green-600");

        setTimeout(() => location.reload(), 1000);

    } catch (err) {
        alert("Save failed: " + err);
        btn.disabled = false;
        btn.innerHTML = original;
    }
}
</script>

</body>
</html>
