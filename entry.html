<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-yellow-400">assignment</span>
                    <span class="font-bold text-xl tracking-tight">Vocational Entry</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="toggleSettings()" class="text-blue-200 hover:text-white transition">
                        <span class="material-icons">settings</span>
                    </button>
                    <a href="admin.html" class="bg-blue-800 hover:bg-blue-700 px-3 py-1 rounded text-xs font-bold uppercase tracking-wide transition">
                        Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div id="settingsPanel" class="hidden bg-slate-800 text-white p-4">
        <div class="max-w-4xl mx-auto">
            <label class="text-xs uppercase font-bold text-gray-400">Database Connection URL</label>
            <div class="flex gap-2 mt-1">
                <input type="text" id="apiUrlInput" placeholder="Paste Google Script URL here..." 
                    class="flex-1 bg-black/30 text-sm p-2 rounded border border-slate-600 focus:border-blue-500 outline-none font-mono text-green-400">
                <button onclick="saveUrl()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-xs font-bold uppercase">Save</button>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 py-8">
        
        <form id="entryForm" onsubmit="submitEntry(event)" class="space-y-6">

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Student & Site</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Student</label>
                        <select id="studentSelect" required class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Loading students...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Job Site</label>
                        <select id="siteSelect" required class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Loading sites...</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Date</label>
                        <input type="date" id="dateInput" required class="w-full p-3 border rounded-lg bg-gray-50 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Evaluator Name</label>
                        <input type="text" id="evaluatorInput" placeholder="e.g. Mr. Smith" required 
                            class="w-full p-3 border rounded-lg bg-gray-50 outline-none">
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Skills Assessment</h2>
                <p class="text-xs text-gray-500 mb-6 uppercase tracking-wider font-bold">Rate from 1 (Low) to 5 (High)</p>
                
                <div id="skillsContainer" class="space-y-6">
                    </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Notes</h2>
                <textarea id="commentsInput" rows="3" placeholder="Additional observations..." 
                    class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>

            <button type="submit" id="submitBtn" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                <span class="material-icons">send</span> SUBMIT ENTRY
            </button>

        </form>
    </div>

    <script>
        // --- 1. CONFIGURATION: MUST MATCH GOOGLE SCRIPT EXACTLY ---
        const SKILLS_LIST = [
            "Punctual",
            "Prepared with Necessary Materials",
            "Demonstrates appropriate hygiene/dress",
            "Initiates familiar tasks",
            "Maintains a productive work rate",
            "Complete tasks in a logical order",
            "Demonstrates adaptability",
            "Work is completed to quality standards",
            "Maintains clean and organized work space",
            "Awareness of surroundings and good decision making",
            "Appropriate and respectful social interactions",
            "Displays effective communication skills",
            "Accepts constructive criticism",
            "Demonstrates a positive attitude",
            "Asks for help appropriately",
            "Demonstrates self-reflection"
        ];

        let API_URL = localStorage.getItem('vocational_backend_url') || "";

        // --- 2. INITIALIZATION ---
        window.onload = function() {
            // Set Date to Today
            document.getElementById('dateInput').valueAsDate = new Date();
            
            // Generate Skill Sliders
            renderSkills();

            // Load Data if URL exists
            if (API_URL) {
                document.getElementById('apiUrlInput').value = API_URL;
                loadDropdowns();
            } else {
                toggleSettings(); // Open settings if no URL
            }
        };

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (url) {
                localStorage.setItem('vocational_backend_url', url);
                API_URL = url;
                alert("URL Saved!");
                loadDropdowns();
                toggleSettings();
            }
        }

        // --- 3. DYNAMIC RENDERING ---
        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = "";

            SKILLS_LIST.forEach((skill, index) => {
                const html = `
                    <div class="skill-row">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${skill}</label>
                        <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <span class="text-xs font-bold text-gray-400 w-4">1</span>
                            <input type="range" min="1" max="5" value="3" step="1" 
                                id="skill_${index}" 
                                oninput="document.getElementById('val_${index}').innerText = this.value"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            <span class="text-xs font-bold text-gray-400 w-4">5</span>
                            <span id="val_${index}" class="ml-2 w-8 text-center font-bold text-blue-600 text-lg bg-white shadow rounded">3</span>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function loadDropdowns() {
            try {
                // Fetch Students
                const sRes = await fetch(`${API_URL}?action=getStudents`);
                const sData = await sRes.json();
                const sSelect = document.getElementById('studentSelect');
                sSelect.innerHTML = '<option value="">Select Student...</option>';
                sData.data.forEach(s => {
                    sSelect.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });

                // Fetch Sites
                const jRes = await fetch(`${API_URL}?action=getJobSites`);
                const jData = await jRes.json();
                const jSelect = document.getElementById('siteSelect');
                jSelect.innerHTML = '<option value="">Select Site...</option>';
                jData.data.forEach(site => {
                    jSelect.innerHTML += `<option value="${site}">${site}</option>`;
                });

            } catch (err) {
                console.error(err);
                alert("Error loading lists. Check your URL in settings.");
            }
        }

        // --- 4. SUBMIT FUNCTION ---
        async function submitEntry(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            
            // Visual Loading State
            btn.disabled = true;
            btn.innerHTML = `<span class="material-icons animate-spin">refresh</span> Saving...`;

            // 1. Gather Basic Data
            const payload = {
                action: "addEntry",
                student_id: document.getElementById('studentSelect').value,
                job_site: document.getElementById('siteSelect').value,
                date: document.getElementById('dateInput').value,
                evaluator: document.getElementById('evaluatorInput').value,
                comments: document.getElementById('commentsInput').value,
                scores: {}
            };

            // 2. Gather Skill Scores (Matching Keys Exactly)
            SKILLS_LIST.forEach((skill, index) => {
                const val = document.getElementById(`skill_${index}`).value;
                payload.scores[skill] = parseInt(val); // Ensure it's a number
            });

            // 3. Send to Google Script
            try {
                // Using no-cors/text-plain to bypass security blocks
                await fetch(API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                // Success Feedback
                btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
                btn.classList.add("bg-green-600", "hover:bg-green-700");
                btn.innerHTML = `<span class="material-icons">check_circle</span> SUCCESS!`;
                
                // Reset Form after 1.5 seconds
                setTimeout(() => {
                    document.getElementById('entryForm').reset();
                    // Reset sliders to 3
                    document.querySelectorAll('input[type="range"]').forEach(r => r.value = 3);
                    document.querySelectorAll('[id^="val_"]').forEach(s => s.innerText = "3");
                    document.getElementById('dateInput').valueAsDate = new Date(); // Reset date
                    
                    // Reset Button
                    btn.disabled = false;
                    btn.classList.add("bg-blue-600", "hover:bg-blue-700");
                    btn.classList.remove("bg-green-600", "hover:bg-green-700");
                    btn.innerHTML = originalText;
                }, 1500);

            } catch (err) {
                alert("Failed to save: " + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
