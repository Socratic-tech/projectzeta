<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setup Guide - Vocational Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        function copyCode() {
            const codeText = document.getElementById('scriptCode').innerText;
            navigator.clipboard.writeText(codeText).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerText = "Copied!";
                btn.classList.add("bg-green-600");
                setTimeout(() => {
                    btn.innerText = "Copy Script Code";
                    btn.classList.remove("bg-green-600");
                }, 2000);
            });
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-20">

    <nav class="bg-white shadow border-b border-gray-200 mb-8 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                        <span class="material-icons">build</span> Setup Guide
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-500 hover:text-indigo-600 font-medium flex items-center gap-1">
                        <span class="material-icons text-sm">arrow_back</span> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        
        <div class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-900">Installation Guide</h1>
            <p class="mt-4 text-xl text-gray-500">Follow these steps exactly to connect your tracker to Google Sheets.</p>
        </div>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 1</span>
                Create the Spreadsheet
            </h2>
            <div class="prose text-gray-600">
                <p class="mb-2">1. Go to <a href="https://sheets.google.com" target="_blank" class="text-indigo-600 underline font-bold">sheets.google.com</a> and create a <strong>Blank Spreadsheet</strong>.</p>
                <p class="mb-2">2. Name it <span class="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-800">Vocational Tracker Database</span>.</p>
                <p class="text-sm text-gray-400 italic">Note: You do not need to create any tabs (columns). The script will do that for you automatically.</p>
            </div>
        </section>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 2</span>
                Open the Script Editor
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="text-gray-600">
                    <p class="mb-4">In your Google Sheet, look at the top menu bar.</p>
                    <p>Click <strong>Extensions</strong> <span class="text-gray-400">→</span> <strong>Apps Script</strong>.</p>
                    <p class="text-sm mt-2 text-gray-400">A new tab will open looking like a code editor.</p>
                </div>
                <div class="bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg h-40 flex items-center justify-center text-gray-500">
                    
                </div>
            </div>
        </section>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 3</span>
                Paste the Backend Code
            </h2>
            
            <p class="text-gray-600 mb-4">Delete any code currently in the editor (usually `function myFunction() {...}`) and paste the code block below:</p>

            <div class="relative mb-6">
                <button id="copyBtn" onclick="copyCode()" class="absolute top-2 right-2 bg-indigo-600 text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-indigo-700 transition shadow">
                    Copy Script Code
                </button>
                <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg text-xs overflow-x-auto h-64 select-all shadow-inner border border-gray-700" id="scriptCode">
function doGet(e) {
  const action = e.parameter.action;
  if (action === "getStudents") return getStudents();
  if (action === "getJobSites") return getJobSites();
  if (action === "getEntries") return getEntries();
  return responseJSON({ status: "error", message: "Invalid action" });
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    // Password Check
    if (action === "verifyPassword") return verifyPassword(data);

    if (action === "addEntry") return addEntry(data);
    if (action === "addStudent") return addStudent(data);
    if (action === "addJobSite") return addJobSite(data);
    if (action === "deleteJobSite") return deleteJobSite(data);
    
    return responseJSON({ status: "error" });
  } catch (error) { 
    return responseJSON({ status: "error", message: error.toString() }); 
  }
}

function verifyPassword(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("Settings");
  if (!sheet) {
    sheet = ss.insertSheet("Settings");
    sheet.appendRow(["Config Name", "Value"]);
    sheet.appendRow(["Admin Password", "1234"]); 
    sheet.appendRow(["Note", "Change cell B2 to update password"]);
  }
  const storedPassword = sheet.getRange("B2").getValue().toString();
  if (String(data.password) === storedPassword) {
    return responseJSON({ status: "success" });
  } else {
    return responseJSON({ status: "error" });
  }
}

function getStudents() {
  const sheet = getSheet("Students");
  const data = sheet.getDataRange().getValues();
  const students = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) students.push({ student_id: data[i][0], name: data[i][1] });
  }
  return responseJSON({ data: students });
}

function getJobSites() {
  const sheet = getSheet("JobSites");
  const data = sheet.getDataRange().getValues();
  const sites = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) sites.push(data[i][0]);
  }
  return responseJSON({ data: sites.sort() });
}

function getEntries() {
  const sheet = getSheet("Entries");
  const data = sheet.getDataRange().getValues();
  const entries = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][2]) { 
      let scores = [];
      try { scores = JSON.parse(data[i][5]); } catch(e) { scores = []; }
      entries.push({
        timestamp: data[i][0], date: data[i][1], student_id: data[i][2],
        job_site: data[i][3], evaluator: data[i][4], scores: scores, comments: data[i][6]
      });
    }
  }
  return responseJSON({ data: entries });
}

function addEntry(data) {
  const sheet = getSheet("Entries");
  sheet.appendRow([new Date(), data.date, data.student_id, data.job_site, data.evaluator, data.scores, data.comments]);
  return responseJSON({ status: "success" });
}

function addStudent(data) {
  const sheet = getSheet("Students");
  const id = "STU" + Date.now(); 
  sheet.appendRow([id, data.name]);
  return responseJSON({ status: "success", id: id });
}

function addJobSite(data) {
  const sheet = getSheet("JobSites");
  sheet.appendRow([data.site_name]);
  return responseJSON({ status: "success" });
}

function deleteJobSite(data) {
  const sheet = getSheet("JobSites");
  const rows = sheet.getDataRange().getValues();
  for (let i = rows.length - 1; i >= 0; i--) {
    if (rows[i][0] === data.site_name) sheet.deleteRow(i + 1);
  }
  return responseJSON({ status: "success" });
}

function getSheet(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    if (name === "Students") sheet.appendRow(["Student ID", "Name"]);
    if (name === "JobSites") sheet.appendRow(["Site Name"]);
    if (name === "Entries") sheet.appendRow(["Timestamp", "Date", "Student ID", "Job Site", "Evaluator", "Scores", "Comments"]);
  }
  return sheet;
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
                </pre>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="text-gray-600">
                    <p>After pasting, click the <strong>Save</strong> icon (floppy disk) in the toolbar.</p>
                    <p class="text-sm mt-1 text-gray-400">Name the project "Vocational Backend" if asked.</p>
                </div>
                <div class="bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg h-32 flex items-center justify-center text-gray-500">
                    
                </div>
            </div>
        </section>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 4</span>
                Deploy as Web App (Critical Step!)
            </h2>
            
            <p class="text-gray-600 mb-4">Click the blue <strong>Deploy</strong> button (top right) and select <strong>New Deployment</strong>.</p>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <h3 class="font-bold text-yellow-800 mb-2">⚙️ Match these settings exactly:</h3>
                <ul class="space-y-3">
                    <li class="flex items-center">
                        <span class="material-icons text-gray-400 mr-2">settings</span>
                        <span><strong>Select Type:</strong> click the gear icon and select <span class="bg-white border px-1 rounded font-mono">Web App</span>.</span>
                    </li>
                    <li class="flex items-center">
                        <span class="material-icons text-gray-400 mr-2">person</span>
                        <span><strong>Execute as:</strong> <span class="bg-green-100 text-green-800 px-1 rounded font-bold">Me (your email)</span></span>
                    </li>
                    <li class="flex items-center">
                        <span class="material-icons text-red-500 mr-2">lock_open</span>
                        <span><strong>Who has access:</strong> <span class="bg-red-100 text-red-800 px-1 rounded font-bold border border-red-200">Anyone</span></span>
                    </li>
                </ul>
                <p class="text-xs text-red-600 mt-3 font-medium">⚠️ If you do not select "Anyone", the app will not work.</p>
            </div>

            <div class="bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg h-64 flex items-center justify-center text-gray-500 mb-6">
                
            </div>

            <p class="text-gray-600">Click <strong>Deploy</strong>. You may be asked to "Authorize Access". Click <strong>Review Permissions</strong> → Choose your account → Click <strong>Advanced</strong> → Click <strong>Go to (unsafe)</strong> (it is safe, it's just your own script).</p>
        </section>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 5</span>
                Copy the Web App URL
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="text-gray-600">
                    <p class="mb-2">Once deployed, you will see a long URL ending in <code class="bg-gray-100 px-1 rounded">/exec</code>.</p>
                    <p class="mb-2"><strong>Copy this URL.</strong> This is your "API Key".</p>
                    <p class="text-sm text-gray-400">It looks like: <em>https://script.google.com/macros/s/.../exec</em></p>
                </div>
                <div class="bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg h-32 flex items-center justify-center text-gray-500">
                   
                </div>
            </div>
        </section>

        <section class="mb-12 border-l-4 border-indigo-600 pl-6 py-2">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full mr-3">Step 6</span>
                Connect the Admin Panel
            </h2>
            
            <div class="prose text-gray-600">
                <p>1. Go back to this vocational tracker and click <a href="admin.html" class="text-indigo-600 font-bold hover:underline">Admin</a>.</p>
                <p>2. You will see a screen asking for the <strong>Web App URL</strong>.</p>
                <p>3. Paste the URL you just copied and click <strong>Connect</strong>.</p>
                <p>4. Once connected, you can add students and job sites!</p>
            </div>
        </section>

    </div>

</body>
</html>
