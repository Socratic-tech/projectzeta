<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Setup Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-slate-900 text-slate-100 font-sans min-h-screen flex flex-col">

    <nav class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="material-icons text-blue-400">build</span>
                <span class="font-bold text-xl">System Setup</span>
            </div>
            <a href="index.html" class="text-slate-400 hover:text-white text-sm">Return to App</a>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-6 space-y-12">

        <div class="text-center space-y-4">
            <h1 class="text-3xl font-bold">Vocational Tracking System Setup</h1>
            <p class="text-slate-400">Follow these steps to configure your Google Sheet backend.</p>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <h2 class="text-xl font-bold">Install Script</h2>
            </div>
            
            <p class="text-slate-400 mb-4 text-sm">
                1. Open your Google Sheet.<br>
                2. Go to <strong>Extensions > Apps Script</strong>.<br>
                3. Delete existing code, paste the code below, and <strong>Save</strong> (Disk Icon).
            </p>

            <div class="relative group">
                <button onclick="copyCode()" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded shadow">
                    COPY CODE
                </button>
                <textarea id="scriptCode" class="w-full h-64 bg-slate-950 text-green-400 font-mono text-xs p-4 rounded border border-slate-600 focus:outline-none" readonly>
// CONFIGURATION
const SPREADSHEET_ID = ""; 
const SHEET_NAME_ENTRIES = "Entries";
const SHEET_NAME_STUDENTS = "Students";
const SHEET_NAME_SETTINGS = "Settings";
const SHEET_NAME_JOBSITES = "JobSites";

// SKILLS LIST (Exact Match to App)
const SKILLS_LIST = [
  "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
  "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
  "Demonstrates adaptability", "Work is completed to quality standards", "Maintains clean and organized work space",
  "Awareness of surroundings and good decision making", "Appropriate and respectful social interactions",
  "Displays effective communication skills", "Accepts constructive criticism", "Demonstrates a positive attitude",
  "Asks for help appropriately", "Demonstrates self-reflection"
];

function doGet(e) {
  const action = e.parameter.action;
  if (action === "checkAdmin") return checkAdminPassword(e.parameter.password);
  if (action === "getStudents") return getStudents();
  if (action === "getJobSites") return getJobSites();
  if (action === "getEntries") return getEntries();
  return responseJSON({status: "error", message: "Invalid Action"});
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const act = data.action;

    if (act === "setup") return setupSpreadsheet(); 
    if (act === "addEntry") return addEntry(data);
    if (act === "addStudent") return addStudent(data);
    if (act === "deleteStudent") return deleteStudent(data);
    if (act === "addJobSite") return addJobSite(data);
    if (act === "deleteJobSite") return deleteJobSite(data);

    return responseJSON({status: "error", message: "Invalid Action"});
  } catch (err) {
    return responseJSON({status: "error", message: err.toString()});
  }
}

// --- SETUP FUNCTION ---
function setupSpreadsheet() {
  const ss = getSpreadsheet();

  // 1. STUDENTS SHEET
  let sSheet = ss.getSheetByName(SHEET_NAME_STUDENTS);
  if (!sSheet) sSheet = ss.insertSheet(SHEET_NAME_STUDENTS);
  if (sSheet.getLastRow() === 0) sSheet.appendRow(["Student ID", "Name", "Grade"]);

  // 2. JOBSITES SHEET
  let jSheet = ss.getSheetByName(SHEET_NAME_JOBSITES);
  if (!jSheet) jSheet = ss.insertSheet(SHEET_NAME_JOBSITES);
  if (jSheet.getLastRow() === 0) jSheet.appendRow(["Site Name"]);

  // 3. SETTINGS SHEET (Password: admin)
  let setSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
  if (!setSheet) setSheet = ss.insertSheet(SHEET_NAME_SETTINGS);
  if (setSheet.getLastRow() === 0) {
    setSheet.appendRow(["Config", "Value"]);
    setSheet.appendRow(["Admin Password", "admin"]); // Default password
  }

  // 4. ENTRIES SHEET
  let eSheet = ss.getSheetByName(SHEET_NAME_ENTRIES);
  if (!eSheet) eSheet = ss.insertSheet(SHEET_NAME_ENTRIES);
  if (eSheet.getLastRow() === 0) {
    // Columns: A=ID, B=Date, C=Student, D=Site, E=Evaluator, F-U=Skills, V=Comments
    let headers = ["Entry ID", "Date", "Student ID", "Job Site", "Evaluator", ...SKILLS_LIST, "Comments"];
    eSheet.appendRow(headers);
  }

  return responseJSON({status: "success", message: "Spreadsheet Configured!"});
}

// --- CORE FUNCTIONS ---

function checkAdminPassword(inputPass) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_SETTINGS);
  const realPass = sheet.getRange("B2").getValue().toString();
  return responseJSON({result: (inputPass === realPass ? "success" : "error")});
}

function getJobSites() {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_JOBSITES);
  if (!sheet) return responseJSON({status: "error", message: "Sheet missing"});
  const data = sheet.getDataRange().getValues();
  if (data.length > 0) data.shift();
  const sites = data.flat().filter(s => s !== "" && s !== null);
  return responseJSON({status: "success", data: sites});
}

function addJobSite(data) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_JOBSITES);
  sheet.appendRow([data.site_name]); 
  return responseJSON({status: "success"});
}

function deleteJobSite(data) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_JOBSITES);
  const rows = sheet.getDataRange().getValues();
  for (let i = 0; i < rows.length; i++) {
    if (rows[i][0] == data.site_name) {
      sheet.deleteRow(i + 1);
      return responseJSON({status: "success"});
    }
  }
  return responseJSON({status: "error"});
}

function getStudents() {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_STUDENTS);
  const data = sheet.getDataRange().getValues();
  data.shift(); 
  const students = data.map(row => ({ student_id: row[0], name: row[1], grade: row[2] })).filter(s => s.student_id !== "");
  return responseJSON({status: "success", data: students});
}

function addStudent(data) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_STUDENTS);
  sheet.appendRow([Utilities.getUuid(), data.name, data.grade]);
  return responseJSON({status: "success"});
}

function deleteStudent(data) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_STUDENTS);
  const rows = sheet.getDataRange().getValues();
  for (let i = 0; i < rows.length; i++) {
    if (rows[i][0] == data.student_id) {
      sheet.deleteRow(i + 1);
      return responseJSON({status: "success"});
    }
  }
  return responseJSON({status: "error"});
}

function addEntry(data) {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_ENTRIES);
  const headers = sheet.getRange("1:1").getValues()[0];
  
  // A=ID, B=Date, C=Student, D=Site, E=Evaluator
  let newRow = [Utilities.getUuid(), data.date, data.student_id, data.job_site, data.evaluator];
  
  // F-U (Indices 5-20) Skills
  for (let i = 5; i <= 20; i++) {
    newRow[i] = data.scores[headers[i]] || "";
  }
  
  // V (Index 21) Comments
  newRow[21] = data.comments;

  sheet.appendRow(newRow);
  return responseJSON({status: "success"});
}

function getEntries() {
  const sheet = getSpreadsheet().getSheetByName(SHEET_NAME_ENTRIES);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  
  const entries = data.map(row => {
    let entry = {
      entry_id: row[0], date: row[1], student_id: row[2], 
      job_site: row[3], evaluator: row[4], scores: {}, 
      comments: row[21] || "" // Column V
    };
    
    // Skills F-U
    for (let i = 5; i <= 20; i++) {
      if(headers[i]) entry.scores[headers[i]] = row[i];
    }
    return entry;
  });
  return responseJSON({status: "success", data: entries});
}

function getSpreadsheet() { return SPREADSHEET_ID ? SpreadsheetApp.openById(SPREADSHEET_ID) : SpreadsheetApp.getActiveSpreadsheet(); }
function responseJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
                </textarea>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <h2 class="text-xl font-bold">Deploy Web App</h2>
            </div>
            <ul class="list-disc pl-5 space-y-2 text-slate-300 text-sm">
                <li>Click <strong>Deploy</strong> (Blue Button) > <strong>New Deployment</strong>.</li>
                <li>Select Type: <strong>Web App</strong>.</li>
                <li>Execute as: <strong>Me</strong>.</li>
                <li>Who has access: <strong>Anyone</strong> (Crucial!).</li>
                <li>Click <strong>Deploy</strong> and copy the URL.</li>
            </ul>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">3</div>
                <h2 class="text-xl font-bold">Auto-Create Sheets</h2>
            </div>
            
            <p class="text-slate-400 mb-4 text-sm">Paste your Web App URL to automatically create headers and set password to "admin".</p>

            <div class="flex gap-2">
                <input type="text" id="setupUrl" placeholder="https://script.google.com/macros/s/..." 
                    class="flex-1 bg-slate-900 border border-slate-600 rounded p-3 text-white outline-none focus:border-blue-500">
                <button onclick="runAutoSetup()" id="setupBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold px-6 rounded shadow transition">
                    CONFIGURE
                </button>
            </div>
            <p id="setupStatus" class="mt-4 text-center font-bold hidden"></p>
        </div>

    </div>

    <script>
        function copyCode() {
            const code = document.getElementById('scriptCode');
            code.select();
            document.execCommand('copy');
            alert("Code copied!");
        }

        async function runAutoSetup() {
            const url = document.getElementById('setupUrl').value.trim();
            const status = document.getElementById('setupStatus');
            const btn = document.getElementById('setupBtn');

            if(!url) return alert("Please enter the Web App URL");

            btn.disabled = true;
            btn.innerText = "Running...";
            status.classList.remove('hidden');
            status.className = "mt-4 text-center font-bold text-yellow-400";
            status.innerText = "Connecting...";

            try {
                // Using no-cors (blind request) to avoid CORS issues in simple setup
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: JSON.stringify({ action: 'setup' })
                });

                status.className = "mt-4 text-center font-bold text-green-400";
                status.innerHTML = "Success! Sheets created.<br>Password set to 'admin'.";
                localStorage.setItem('vocational_backend_url', url);

            } catch (e) {
                console.error(e);
                status.className = "mt-4 text-center font-bold text-red-400";
                status.innerText = "Error: " + e.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "CONFIGURE";
            }
        }
    </script>
</body>
</html>
