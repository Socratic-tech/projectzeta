<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 font-sans pb-10">

    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96 text-center">
            
            <div id="setupView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-indigo-600">Connect Database</h2>
                <p class="text-sm text-gray-500 mb-4">Paste your Web App URL to begin.</p>
                <input type="text" id="setupUrl" class="w-full border p-3 rounded mb-4 text-sm" placeholder="https://script.google.com/...">
                <button onclick="saveSetup()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700 transition">Connect</button>
            </div>

            <div id="loginView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Login</h2>
                <input type="password" id="authInput" class="w-full border p-3 rounded mb-4 text-center text-xl tracking-widest" placeholder="Enter PIN">
                <button id="loginBtn" onclick="attemptLogin()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700 transition">Unlock System</button>
                <p id="authError" class="text-red-500 text-sm mt-3 hidden">Incorrect PIN.</p>
                <button onclick="clearSetup()" class="text-xs text-gray-400 mt-6 underline">Reset Connection</button>
            </div>

        </div>
    </div>

    <div id="appContent" class="hidden">
        <nav class="bg-white shadow border-b border-gray-200 mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <a href="index.html" class="flex items-center text-gray-500 hover:text-indigo-600 mr-4">
                            <span class="material-icons">arrow_back</span>
                        </a>
                        <h1 class="text-xl font-bold text-indigo-600">Admin Panel</h1>
                    </div>
                    <div class="flex items-center"><button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm font-medium">Logout</button></div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Manage Students</h2>
                <div class="flex gap-2 mb-4"><input type="text" id="newStudentName" class="flex-1 border p-2 rounded" placeholder="New Student Name"><button onclick="addStudent()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add</button></div>
                <ul id="studentList" class="divide-y divide-gray-200 border rounded"><li class="p-3 text-center text-gray-400">Loading...</li></ul>
            </div>

            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Manage Job Sites</h2>
                <div class="flex gap-2 mb-4"><input type="text" id="newJobSite" class="flex-1 border p-2 rounded" placeholder="New Job Site Name"><button onclick="addJobSite()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add</button></div>
                <ul id="jobSiteList" class="divide-y divide-gray-200 border rounded"><li class="p-3 text-center text-gray-400">Loading...</li></ul>
            </div>
            
             <div class="bg-white p-6 rounded shadow border-l-4 border-yellow-400">
                <h2 class="text-xl font-bold mb-2">Security Settings</h2>
                <p class="text-gray-600 text-sm mb-4">To change the password, go to the <strong>Settings</strong> tab in your Google Sheet and edit cell <strong>B2</strong>.</p>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'bresa_api_url';
        let API_URL = localStorage.getItem(API_KEY);

        function checkAuth() {
            // IF NO URL -> Show Setup
            if (!API_URL) {
                document.getElementById('setupView').classList.remove('hidden');
                document.getElementById('loginView').classList.add('hidden');
                return;
            }
            // IF URL exists -> Show Login
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');

            if (sessionStorage.getItem('auth') === 'true') {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                loadData();
            }
        }

        // 1. SAVE URL (First Time)
        function saveSetup() {
            const url = document.getElementById('setupUrl').value.trim();
            if(!url) return alert("Please enter URL");
            localStorage.setItem(API_KEY, url);
            API_URL = url;
            checkAuth(); // Now switch to Login View
        }

        // 2. CHECK PASSWORD (Every Time)
        async function attemptLogin() {
            const input = document.getElementById('authInput').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('authError');
            btn.disabled = true; btn.innerText = "Verifying..."; err.classList.add('hidden');

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "verifyPassword", password: input }) });
                const data = await res.json();
                if (data.status === "success") { sessionStorage.setItem('auth', 'true'); checkAuth(); } 
                else { err.classList.remove('hidden'); btn.disabled = false; btn.innerText = "Unlock System"; }
            } catch (e) { alert("Connection Error"); btn.disabled = false; btn.innerText = "Unlock System"; }
        }

        function logout() { sessionStorage.removeItem('auth'); window.location.reload(); }
        function clearSetup() { if(confirm("Disconnect from current database?")) { localStorage.removeItem(API_KEY); window.location.reload(); } }
        document.getElementById('authInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') attemptLogin(); });

        async function loadData() {
            try {
                const sRes = await fetch(API_URL + "?action=getStudents");
                const sData = await sRes.json();
                renderStudents(sData.data);
                const jRes = await fetch(API_URL + "?action=getJobSites");
                const jData = await jRes.json();
                renderJobSites(jData.data);
            } catch(e) { console.error(e); }
        }

        function renderStudents(list) {
            const ul = document.getElementById('studentList'); ul.innerHTML = "";
            if(!list || list.length === 0) return ul.innerHTML = '<li class="p-3 text-gray-500 text-center">No students found.</li>';
            list.forEach(s => { ul.innerHTML += `<li class="p-3 flex justify-between items-center hover:bg-gray-50"><span>${s.name}</span><span class="text-xs text-gray-400">ID: ${s.student_id}</span></li>`; });
        }
        function renderJobSites(list) {
            const ul = document.getElementById('jobSiteList'); ul.innerHTML = "";
            if(!list || list.length === 0) return ul.innerHTML = '<li class="p-3 text-gray-500 text-center">No job sites found.</li>';
            list.forEach(site => { ul.innerHTML += `<li class="p-3 flex justify-between items-center hover:bg-gray-50"><span>${site}</span><button onclick="deleteJobSite('${site}')" class="text-red-500 hover:underline text-xs">Remove</button></li>`; });
        }
        async function addStudent() {
            const name = document.getElementById('newStudentName').value; if(!name) return;
            document.getElementById('newStudentName').value = "";
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "addStudent", name: name }) });
            loadData();
        }
        async function addJobSite() {
            const site = document.getElementById('newJobSite').value; if(!site) return;
            document.getElementById('newJobSite').value = "";
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "addJobSite", site_name: site }) });
            loadData();
        }
        async function deleteJobSite(siteName) {
            if(!confirm("Remove " + siteName + "?")) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "deleteJobSite", site_name: siteName }) });
            loadData();
        }
        checkAuth();
    </script>
</body>
</html>
