<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .login-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98);
            display: flex; justify-content: center; align-items: center; z-index: 50;
        }
        /* Loading Spinner Animation */
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <div id="loginOverlay" class="login-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full border border-gray-200 text-center">
            <span class="material-icons text-6xl text-blue-600 mb-4">admin_panel_settings</span>
            <h2 class="text-2xl font-bold mb-2">Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Enter Password (1234)" 
                class="w-full p-3 border rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none text-center"
                onkeypress="if(event.key === 'Enter') checkPassword()">
            <button onclick="checkPassword()" 
                class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">
                Unlock
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-3 hidden">Incorrect Password</p>
        </div>
    </div>

    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-blue-400">shield</span>
                    <span class="font-bold text-xl tracking-tight">Vocational Admin</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="text-gray-300 hover:text-white px-3 py-2 rounded text-sm font-medium">Dashboard</a>
                    <a href="report.html" class="text-gray-300 hover:text-white px-3 py-2 rounded text-sm font-medium">Reports</a>
                    <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-bold ml-4">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">

        <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg mb-8 border border-slate-700">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span class="material-icons text-green-400">link</span> Connection Settings
                    </h2>
                    <p class="text-slate-400 text-xs mt-1">Paste your Google Script URL below to connect.</p>
                </div>
                <button onclick="runDiagnostics()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-xs uppercase tracking-wide">
                    Test Connection
                </button>
            </div>

            <div class="flex gap-2 mb-4">
                <input type="text" id="apiUrlInput" placeholder="https://script.google.com/macros/s/.../exec" 
                    class="flex-1 bg-black/30 text-green-400 font-mono text-xs p-3 rounded border border-slate-600 focus:border-green-500 outline-none">
                <button onclick="saveUrl()" class="bg-green-600 hover:bg-green-500 px-6 rounded font-bold text-xs uppercase">Save</button>
            </div>

            <div id="consoleLog" class="bg-black/50 p-3 rounded font-mono text-xs h-24 overflow-y-auto border border-slate-700 text-slate-500">
                System ready...
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-icons text-blue-600">school</span> Manage Students
                    </h3>
                    <button onclick="refreshData()" class="text-blue-500 hover:text-blue-700 text-sm flex items-center gap-1">
                        <span class="material-icons text-sm">refresh</span> Refresh
                    </button>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="newStudentName" placeholder="New Student Name" 
                        class="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <button onclick="addItem('addStudent', 'newStudentName')" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 font-bold text-sm">
                        Add
                    </button>
                </div>

                <div class="overflow-y-auto max-h-80 border rounded bg-slate-50">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-500 sticky top-0">
                            <tr><th class="p-3">Name</th><th class="p-3 text-right">ID</th></tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr><td colspan="2" class="p-4 text-center text-slate-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-icons text-orange-600">storefront</span> Manage Job Sites
                    </h3>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="newSiteName" placeholder="New Site Name" 
                        class="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-orange-500 outline-none">
                    <button onclick="addItem('addJobSite', 'newSiteName')" class="bg-orange-600 text-white px-4 rounded hover:bg-orange-700 font-bold text-sm">
                        Add
                    </button>
                </div>

                <div class="overflow-y-auto max-h-80 border rounded bg-slate-50">
                    <ul id="sitesList" class="divide-y divide-slate-200">
                        <li class="p-4 text-center text-slate-400">Loading...</li>
                    </ul>
                </div>
            </div>

        </div>

        <div class="mt-8 text-center">
            <button onclick="window.open(localStorage.getItem('vocational_backend_url').replace('/exec','/edit'))" 
                class="text-slate-400 hover:text-blue-500 text-sm underline">
                Open Google Sheet directly
            </button>
        </div>

    </div>

    <script>
        const ADMIN_PASS = "1234";
        let API_URL = "";

        // --- AUTH & INIT ---
        function checkPassword() {
            if (document.getElementById('passwordInput').value === ADMIN_PASS) {
                document.getElementById('loginOverlay').classList.add('hidden');
                loadSettings();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function loadSettings() {
            API_URL = localStorage.getItem('vocational_backend_url');
            if (API_URL) {
                document.getElementById('apiUrlInput').value = API_URL;
                log("URL Loaded. Fetching data...");
                refreshData();
            } else {
                log("⚠️ No URL found. Please paste your Web App URL above.", "text-yellow-400");
            }
        }

        function saveUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if(!url.includes("script.google.com")) {
                alert("That doesn't look like a Google Script URL.");
                return;
            }
            localStorage.setItem('vocational_backend_url', url);
            API_URL = url;
            log("URL Saved!", "text-green-400");
            runDiagnostics();
        }

        // --- DATA FETCHING (GET) ---
        async function refreshData() {
            if (!API_URL) return;
            
            // Cache Buster: &t=DATE prevents browser from showing old data
            const cacheBuster = `&t=${Date.now()}`;
            
            try {
                // Fetch Students
                const sRes = await fetch(`${API_URL}?action=getStudents${cacheBuster}`);
                const sData = await sRes.json();
                renderStudents(sData.data || []);

                // Fetch Sites
                const jRes = await fetch(`${API_URL}?action=getJobSites${cacheBuster}`);
                const jData = await jRes.json();
                renderSites(jData.data || []);

                log("Data refreshed successfully.", "text-green-400");
            } catch (err) {
                log("Error fetching data: " + err.message, "text-red-400");
            }
        }

        // --- DATA SENDING (POST) ---
        async function addItem(action, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if (!value) return;

            // Clear input immediately for better UX
            input.value = "";
            log(`Sending command: ${action}...`, "text-blue-400");

            // Payload
            const payload = { 
                action: action, 
                // Handle both name fields dynamically
                name: value, 
                site_name: value 
            };

            // THE FIX: use no-cors and text/plain to bypass security blocks
            const options = {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            };

            try {
                await fetch(API_URL, options);
                
                log("Sent! Waiting for Google Sheets...", "text-yellow-400");
                
                // Wait 2.5 seconds for Google to save, then refresh
                setTimeout(() => {
                    refreshData();
                    log("Database synced.", "text-green-400");
                }, 2500);

            } catch (err) {
                log("Send failed: " + err.message, "text-red-400");
            }
        }

        async function deleteSite(name) {
            if (!confirm(`Delete ${name}?`)) return;
            
            log(`Deleting ${name}...`, "text-red-400");
            
            const options = {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action: "deleteJobSite", site_name: name })
            };

            await fetch(API_URL, options);
            setTimeout(refreshData, 2500);
        }

        // --- RENDERERS ---
        function renderStudents(list) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = list.length ? "" : "<tr><td colspan='2' class='p-4 text-center text-slate-400 italic'>No students found</td></tr>";
            
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition";
                tr.innerHTML = `
                    <td class="p-3 font-medium text-slate-700">${s.name}</td>
                    <td class="p-3 text-right text-xs font-mono text-slate-400">${s.student_id}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSites(list) {
            const ul = document.getElementById('sitesList');
            ul.innerHTML = list.length ? "" : "<li class='p-4 text-center text-slate-400 italic'>No sites found</li>";
            
            list.forEach(site => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-3 hover:bg-slate-50 transition";
                li.innerHTML = `
                    <span class="font-medium text-slate-700">${site}</span>
                    <button onclick="deleteSite('${site}')" class="text-slate-300 hover:text-red-500 transition">
                        <span class="material-icons text-lg">delete</span>
                    </button>
                `;
                ul.appendChild(li);
            });
        }

        // --- DIAGNOSTICS & LOGGING ---
        function log(msg, colorClass = "text-slate-400") {
            const consoleBox = document.getElementById('consoleLog');
            const entry = document.createElement('div');
            entry.className = colorClass;
            entry.innerText = `> ${msg}`;
            consoleBox.appendChild(entry);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        async function runDiagnostics() {
            log("--- STARTING DIAGNOSTIC ---", "text-white");
            if (!API_URL) { log("FAIL: No URL Provided", "text-red-500"); return; }

            try {
                // Test 1: Students
                const t0 = performance.now();
                const res = await fetch(`${API_URL}?action=getStudents`);
                if (!res.ok) throw new Error("HTTP " + res.status);
                const data = await res.json();
                const t1 = performance.now();
                log(`✓ API Connect Success (${Math.round(t1-t0)}ms)`, "text-green-400");
                
                // Test 2: Entries (The Complex One)
                const res2 = await fetch(`${API_URL}?action=getEntries`);
                const data2 = await res2.json();
                
                if (data2.status === 'error') {
                    log("✖ DATABASE ERROR: " + data2.message, "text-red-500 font-bold");
                    log("FIX: Delete 'Entries' tab in Sheet", "text-yellow-400");
                } else {
                    log(`✓ Database Structure OK (${data2.data.length} entries)`, "text-green-400");
                }
            } catch (err) {
                log("✖ FATAL ERROR: " + err.message, "text-red-500 font-bold");
                if (err.message.includes("Failed to fetch")) {
                    log("HINT: Redeploy script as 'Anyone'", "text-yellow-400");
                }
            }
        }
    </script>
</body>
</html>
