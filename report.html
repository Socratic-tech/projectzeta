<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .card { border: none; shadow: none; break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <nav class="bg-indigo-700 text-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons">analytics</span>
                    <span class="font-bold text-xl">Vocational Reports</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:bg-indigo-600 px-3 py-2 rounded transition flex items-center gap-1">
                        <span class="material-icons text-sm">dashboard</span> Dashboard
                    </a>
                    <button onclick="window.print()" class="bg-white text-indigo-700 font-bold px-4 py-2 rounded hover:bg-gray-100 transition flex items-center gap-1">
                        <span class="material-icons text-sm">print</span> Print
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="errorBanner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm">
            <h3 class="font-bold text-lg">Connection Error</h3>
            <p id="errorText">Could not load data.</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 no-print">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Select Student</label>
                    <select id="studentSelect" onchange="updateDashboard()" class="w-full p-3 border rounded bg-gray-50 outline-none">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Time Period</label>
                    <select id="timeRange" onchange="updateDashboard()" class="w-full p-3 border rounded bg-gray-50 outline-none">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="180">Last 6 Months</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-700 mx-auto mb-4"></div>
            <p class="text-gray-500">Syncing database...</p>
        </div>

        <div id="reportContent" class="hidden">
            
            <div class="mb-8 border-b pb-4 flex justify-between items-end">
                <div>
                    <h1 id="studentNameTitle" class="text-3xl font-bold text-gray-900">Student Name</h1>
                    <p class="text-gray-500">Vocational Skills Progress Report</p>
                </div>
                <div class="text-right text-sm text-gray-400">
                    Generated: <span id="reportDate"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 card">
                    <p class="text-xs text-gray-500 font-bold uppercase">Evaluations</p>
                    <p id="totalLogs" class="text-2xl font-bold text-gray-900">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 card">
                    <p class="text-xs text-gray-500 font-bold uppercase">Average Score</p>
                    <p id="avgScore" class="text-2xl font-bold text-gray-900">0.0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 card">
                    <p class="text-xs text-gray-500 font-bold uppercase">Strongest Skill</p>
                    <p id="topSkill" class="text-lg font-bold text-gray-900 leading-tight">N/A</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 break-inside-avoid card">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Skill Proficiency (1-5 Scale)</h3>
                <div class="relative h-96 w-full">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8 break-inside-avoid card">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Recent Comments</h3>
                </div>
                <div class="p-6">
                    <ul id="commentsList" class="space-y-4"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SKILLS_LIST = [
            "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
            "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
            "Demonstrates adaptability", "Work is completed to quality standards", "Maintains clean and organized work space",
            "Awareness of surroundings and good decision making", "Appropriate and respectful social interactions",
            "Displays effective communication skills", "Accepts constructive criticism", "Demonstrates a positive attitude",
            "Asks for help appropriately", "Demonstrates self-reflection"
        ];

        let allEntries = [];
        let studentsMap = {};
        let chartInstance = null;

        // --- THE DATE FIXER ---
        // Converts "2023-10-25T..." or "2023-10-25" into a pure Local Date object
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            // If it's a full ISO string (from Google), take the first 10 chars (YYYY-MM-DD)
            const cleanStr = dateStr.substring(0, 10);
            const parts = cleanStr.split('-');
            // Create date using Local Time (Year, MonthIndex, Day)
            // Month is 0-indexed in JS (0=Jan, 9=Oct)
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        // --- INIT ---
        window.addEventListener('load', async () => {
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
            
            let apiUrl = localStorage.getItem('vocational_backend_url');
            if (!apiUrl) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('errorBanner').classList.remove('hidden');
                document.getElementById('errorText').innerText = "Please go to Admin and connect the database.";
                return;
            }

            try {
                // Cache Buster to get fresh data
                const t = Date.now();
                
                const [sRes, eRes] = await Promise.all([
                    fetch(`${apiUrl}?action=getStudents&t=${t}`),
                    fetch(`${apiUrl}?action=getEntries&t=${t}`)
                ]);

                const sData = await sRes.json();
                const eData = await eRes.json();

                if (sData.status === 'error' || eData.status === 'error') throw new Error("Database Error");

                // Load Students
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">-- Select Student --</option>';
                sData.data.forEach(s => {
                    studentsMap[s.student_id] = s.name;
                    select.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });

                allEntries = eData.data;
                document.getElementById('loadingIndicator').classList.add('hidden');

            } catch (err) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('errorBanner').classList.remove('hidden');
                console.error(err);
            }
        });

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const studentId = document.getElementById('studentSelect').value;
            const range = document.getElementById('timeRange').value;
            const container = document.getElementById('reportContent');

            if (!studentId) {
                container.classList.add('hidden');
                return;
            }

            document.getElementById('studentNameTitle').innerText = studentsMap[studentId];
            container.classList.remove('hidden');

            // --- FILTERING WITH FIXED DATES ---
            const today = new Date();
            // Reset hours to ensure fair comparison
            today.setHours(0,0,0,0);
            
            const cutoffDate = new Date(today);
            if (range !== 'all') {
                cutoffDate.setDate(today.getDate() - parseInt(range));
            }

            const filtered = allEntries.filter(e => {
                if(e.student_id.toString() !== studentId) return false;
                if(range === 'all') return true;
                
                const entryDate = parseDate(e.date);
                return entryDate >= cutoffDate;
            });

            if (filtered.length === 0) {
                // Empty State
                document.getElementById('totalLogs').innerText = "0";
                document.getElementById('avgScore').innerText = "-";
                document.getElementById('topSkill').innerText = "-";
                document.getElementById('commentsList').innerHTML = "<li class='text-gray-400 italic text-center'>No records found in this period.</li>";
                if(chartInstance) chartInstance.destroy();
                return;
            }

            // --- CALCULATIONS ---
            let skillSums = {};
            let skillCounts = {};
            SKILLS_LIST.forEach(s => { skillSums[s] = 0; skillCounts[s] = 0; });
            let grandSum = 0, grandCount = 0;

            filtered.forEach(entry => {
                SKILLS_LIST.forEach(skill => {
                    const score = parseFloat(entry.scores[skill]);
                    if (!isNaN(score) && score > 0) {
                        skillSums[skill] += score;
                        skillCounts[skill]++;
                        grandSum += score;
                        grandCount++;
                    }
                });
            });

            // Update Metrics
            document.getElementById('totalLogs').innerText = filtered.length;
            document.getElementById('avgScore').innerText = grandCount ? (grandSum / grandCount).toFixed(1) : "0.0";

            // Prepare Chart
            let labels = [], data = [], bestAvg = -1, bestName = "N/A";
            SKILLS_LIST.forEach(skill => {
                const avg = skillCounts[skill] ? (skillSums[skill] / skillCounts[skill]) : 0;
                labels.push(skill);
                data.push(avg.toFixed(1));
                if (avg > bestAvg && avg > 0) { bestAvg = avg; bestName = skill; }
            });
            document.getElementById('topSkill').innerText = bestName;

            renderChart(labels, data);

            // Render Comments (Sorted by Date Descending)
            const list = document.getElementById('commentsList');
            list.innerHTML = "";
            const sorted = filtered.sort((a,b) => parseDate(b.date) - parseDate(a.date)).slice(0, 5);
            
            sorted.forEach(e => {
                if (e.comments) {
                    const d = parseDate(e.date);
                    const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
                    
                    list.innerHTML += `
                        <li class="border-b border-gray-100 pb-2 mb-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-indigo-600">${dateStr}</span>
                                <span class="text-gray-400">${e.job_site}</span>
                            </div>
                            <p class="text-sm italic text-gray-700">"${e.comments}"</p>
                            <p class="text-xs text-right text-gray-400 mt-1">- ${e.evaluator}</p>
                        </li>
                    `;
                }
            });
            if (!list.innerHTML) list.innerHTML = "<li class='text-gray-400 italic text-center'>No comments.</li>";
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('skillsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score', data: data,
                        backgroundColor: data.map(v => v >= 4 ? '#22c55e' : v >= 3 ? '#4f46e5' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 5 }, y: { ticks: { autoSkip: false, font: {size: 10} } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
