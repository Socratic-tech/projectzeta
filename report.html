<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none; }
            .print-only { display: block; }
            body { background: white; }
            .card { border: none; shadow: none; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <nav class="bg-indigo-700 text-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons">analytics</span>
                    <span class="font-bold text-xl">Vocational Reports</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:bg-indigo-600 px-3 py-2 rounded transition flex items-center gap-1">
                        <span class="material-icons text-sm">dashboard</span> Dashboard
                    </a>
                    <button onclick="window.print()" class="bg-white text-indigo-700 font-bold px-4 py-2 rounded hover:bg-gray-100 transition flex items-center gap-1">
                        <span class="material-icons text-sm">print</span> Print
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="errorBanner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm" role="alert">
            <h3 class="font-bold text-lg"><span class="material-icons align-bottom">error</span> Connection Failed</h3>
            <p id="errorText">Could not load data.</p>
            <div id="debugInfo" class="mt-2 text-xs font-mono bg-red-50 p-2 rounded border border-red-200 hidden"></div>
            <div class="mt-3">
                <a href="admin.html" class="text-sm font-bold underline hover:text-red-900">Go to Admin Settings to fix URL</a>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 no-print">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Student</label>
                    <select id="studentSelect" onchange="updateDashboard()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50">
                        <option value="">Loading students...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                    <select id="timeRange" onchange="updateDashboard()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="reportContent" class="hidden">
            <div class="mb-8 border-b pb-4">
                <h1 id="studentNameTitle" class="text-3xl font-bold text-gray-900">Student Name</h1>
                <p class="text-gray-500">Progress Summary</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-50 text-blue-600 mr-4"><span class="material-icons text-3xl">history_edu</span></div>
                        <div><p class="text-sm text-gray-500 font-medium">Total Evaluations</p><p id="totalLogs" class="text-2xl font-bold text-gray-900">0</p></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-50 text-green-600 mr-4"><span class="material-icons text-3xl">star</span></div>
                        <div><p class="text-sm text-gray-500 font-medium">Average Score</p><p id="avgScore" class="text-2xl font-bold text-gray-900">0.0</p></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-50 text-purple-600 mr-4"><span class="material-icons text-3xl">thumb_up</span></div>
                        <div><p class="text-sm text-gray-500 font-medium">Strongest Skill</p><p id="topSkill" class="text-lg font-bold text-gray-900 leading-tight">N/A</p></div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 page-break-inside-avoid">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Skill Proficiency Profile</h3>
                <div class="relative h-96 w-full">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8 page-break-inside-avoid">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Recent Comments</h3>
                </div>
                <div class="p-6">
                    <ul id="commentsList" class="space-y-4"></ul>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-700 mx-auto mb-4"></div>
            <p class="text-gray-500">Connecting to Google Database...</p>
        </div>

    </div>

    <script>
        // 1. CONFIGURATION: Matched to your Backend (Correct Spelling)
        const SKILLS_LIST = [
          "Punctual",
          "Prepared with Necessary Materials",
          "Demonstrates appropriate hygiene/dress",
          "Initiates familiar tasks",
          "Maintains a productive work rate",
          "Complete tasks in a logical order",
          "Demonstrates adaptability",
          "Work is completed to quality standards",
          "Maintains clean and organized work space",
          "Awareness of surroundings and good decision making",
          "Appropriate and respectful social interactions", 
          "Displays effective communication skills",
          "Accepts constructive criticism",
          "Demonstrates a positive attitude",
          "Asks for help appropriately",
          "Demonstrates self-reflection"
        ];

        let allEntries = [];
        let studentsMap = {};
        let chartInstance = null;

        // 2. INITIALIZATION
        window.addEventListener('load', async () => {
            // Retrieve URL and clean it up (trim spaces/quotes)
            let apiUrl = localStorage.getItem('vocational_backend_url');
            if (apiUrl) apiUrl = apiUrl.trim().replace(/['"]+/g, '');

            if (!apiUrl) {
                showError("No database URL found.", "Please go to 'Admin' and paste your Google Script URL.");
                return;
            }

            try {
                // Fetch Students
                const sResponse = await fetch(`${apiUrl}?action=getStudents`);
                if (!sResponse.ok) throw new Error(`Student Fetch Failed: ${sResponse.status}`);
                const sData = await sResponse.json();
                
                if (sData.status === "error") throw new Error(sData.message);

                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">-- Select a Student --</option>';
                
                sData.data.forEach(stu => {
                    studentsMap[stu.student_id] = stu.name;
                    let opt = document.createElement('option');
                    opt.value = stu.student_id;
                    opt.innerText = stu.name;
                    select.appendChild(opt);
                });

                // Fetch Entries
                const eResponse = await fetch(`${apiUrl}?action=getEntries`);
                if (!eResponse.ok) throw new Error(`Entries Fetch Failed: ${eResponse.status}`);
                const eData = await eResponse.json();
                
                if (eData.status === "error") throw new Error(eData.message);
                
                allEntries = eData.data;
                document.getElementById('loadingIndicator').classList.add('hidden');

            } catch (err) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                console.error(err);
                // Show detailed error on screen
                let debugMsg = err.toString();
                if (err.message.includes("Unexpected token")) {
                    debugMsg += " (This usually means the Script URL is wrong or the Script crashed)";
                }
                showError("Failed to connect to Google Sheets.", debugMsg);
            }
        });

        // 3. CORE LOGIC
        function updateDashboard() {
            const studentId = document.getElementById('studentSelect').value;
            const range = document.getElementById('timeRange').value;
            const container = document.getElementById('reportContent');

            if (!studentId) {
                container.classList.add('hidden');
                return;
            }

            // Set Title
            document.getElementById('studentNameTitle').innerText = studentsMap[studentId];
            container.classList.remove('hidden');

            // Filter Data
            const cutoffDate = new Date();
            if (range !== 'all') {
                cutoffDate.setDate(cutoffDate.getDate() - parseInt(range));
            }

            const filtered = allEntries.filter(e => {
                const entryDate = new Date(e.date);
                return e.student_id.toString() === studentId && (range === 'all' || entryDate >= cutoffDate);
            });

            if (filtered.length === 0) {
                document.getElementById('totalLogs').innerText = "0";
                document.getElementById('avgScore').innerText = "N/A";
                document.getElementById('topSkill').innerText = "No Data";
                document.getElementById('commentsList').innerHTML = "<li class='text-gray-400 italic'>No records found for this period.</li>";
                if(chartInstance) chartInstance.destroy();
                return;
            }

            // Calculate Metrics
            let skillSums = {};
            let skillCounts = {};
            SKILLS_LIST.forEach(s => { skillSums[s] = 0; skillCounts[s] = 0; });

            let totalScoreSum = 0;
            let totalScoreCount = 0;

            filtered.forEach(entry => {
                SKILLS_LIST.forEach(skill => {
                    if (entry.scores && entry.scores[skill] !== "" && entry.scores[skill] !== undefined) {
                        const score = parseFloat(entry.scores[skill]);
                        if (!isNaN(score)) {
                            skillSums[skill] += score;
                            skillCounts[skill]++;
                            totalScoreSum += score;
                            totalScoreCount++;
                        }
                    }
                });
            });

            // Update DOM Stats
            document.getElementById('totalLogs').innerText = filtered.length;
            document.getElementById('avgScore').innerText = totalScoreCount > 0 ? (totalScoreSum / totalScoreCount).toFixed(1) : "0.0";

            // Determine Top Skill & Prepare Chart Data
            let chartLabels = [];
            let chartData = [];
            let bestSkillName = "N/A";
            let bestSkillAvg = -1;

            SKILLS_LIST.forEach(skill => {
                const avg = skillCounts[skill] > 0 ? (skillSums[skill] / skillCounts[skill]) : 0;
                chartLabels.push(skill);
                chartData.push(avg.toFixed(1));

                if (avg > bestSkillAvg) {
                    bestSkillAvg = avg;
                    bestSkillName = skill;
                }
            });

            document.getElementById('topSkill').innerText = bestSkillName;

            // Render Chart
            renderChart(chartLabels, chartData);

            // Render Comments (Last 5)
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = "";
            const recentEntries = filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            recentEntries.forEach(e => {
                if (e.comments) {
                    const li = document.createElement('li');
                    li.className = "border-b border-gray-100 last:border-0 pb-2";
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">${formatDate(e.date)}</span>
                            <span class="text-xs text-gray-400">Site: ${e.job_site}</span>
                        </div>
                        <p class="text-sm text-gray-700 italic">"${e.comments}"</p>
                    `;
                    commentsList.appendChild(li);
                }
            });
            
            if (commentsList.children.length === 0) {
                commentsList.innerHTML = "<li class='text-gray-400 italic'>No written comments in this period.</li>";
            }
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('skillsChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Score (1-5)',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 5, grid: { color: '#f3f4f6' } },
                        y: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 11 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function formatDate(dateString) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function showError(title, detail) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('errorBanner').classList.remove('hidden');
            document.getElementById('errorText').innerText = title;
            if(detail) {
                const debug = document.getElementById('debugInfo');
                debug.innerText = detail;
                debug.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
