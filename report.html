<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vocational Report Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* SCREEN STYLES */
        body { background-color: #F3F4F6; }
        
        /* PRINT STYLES - THE REPORT CARD LOOK */
        @media print {
            @page { margin: 0.5in; size: portrait; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            
            /* Hide Interface Elements */
            .no-print { display: none !important; }
            
            /* Report Container adjustments for Paper */
            #reportContainer {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }

            /* Chart Sizing for Print */
            #chartContainer { 
                height: 350px !important; 
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 10px;
                margin-bottom: 20px;
            }

            /* Force Grid to look like a scorecard */
            #skillsGrid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
            }
            
            /* Force Page Break before the history logs */
            .history-section { page-break-before: always; }
        }
    </style>
</head>
<body class="text-gray-900 font-sans p-6">

    <div class="max-w-6xl mx-auto flex justify-between items-center mb-6 no-print">
        <h1 class="text-3xl font-bold text-gray-800">Vocational Dashboard</h1>
        <a href="home.html" class="text-indigo-600 hover:underline">Back to Home</a>
    </div>

    <div class="max-w-6xl mx-auto bg-white p-5 rounded-lg shadow mb-6 no-print border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Student</label>
                <select id="studentSelect" onchange="loadStudentData()" class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select Student...</option>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Start Date</label>
                <input type="date" id="startDate" onchange="loadStudentData()" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">End Date</label>
                <input type="date" id="endDate" onchange="loadStudentData()" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
            </div>

            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Job Site</label>
                <select id="siteFilter" onchange="loadStudentData()" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500">
                    <option value="All">All Sites</option>
                </select>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t flex justify-end">
            <button onclick="window.print()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-bold shadow flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                Print Report Card
            </button>
        </div>
    </div>

    <div id="reportContainer" class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg hidden min-h-screen">
        
        <div class="flex justify-between items-start border-b-4 border-indigo-600 pb-4 mb-6">
            <div>
                <h2 id="studentName" class="text-4xl font-bold text-gray-900">Student Name</h2>
                <div class="mt-2 text-gray-600">
                    <p><strong>Report Period:</strong> <span id="dateRangeDisplay">--</span></p>
                    <p><strong>Job Site Filter:</strong> <span id="siteDisplay">All</span></p>
                </div>
            </div>
            <div class="text-right bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-xs text-gray-500 uppercase tracking-wide font-bold mb-1">Overall Average</div>
                <div id="overallScore" class="text-5xl font-bold text-gray-800 leading-none">--</div>
                <div class="text-xs text-gray-400 mt-1">Scale: 0.0 - 4.0</div>
            </div>
        </div>

        <div id="chartContainer" class="mb-8 h-80 relative">
            <canvas id="skillsChart"></canvas>
        </div>

        <h3 class="font-bold text-lg mb-3 text-gray-800 uppercase tracking-wider border-b border-gray-300 pb-1">Detailed Skill Breakdown</h3>
        <div id="skillsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            </div>

        <div class="history-section pt-4">
            <h3 class="font-bold text-lg mb-4 text-gray-800 uppercase tracking-wider border-b border-gray-300 pb-1">Evaluation History</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b-2 border-gray-300 text-gray-600 uppercase text-xs">
                            <th class="p-3">Date</th>
                            <th class="p-3">Job Site</th>
                            <th class="p-3">Evaluator</th>
                            <th class="p-3 text-center">Score</th>
                            <th class="p-3 w-1/3">Notes</th>
                            <th class="p-3 text-right no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 no-print">
        <div class="relative top-10 mx-auto p-6 border w-11/12 md:w-3/4 lg:w-1/2 shadow-2xl rounded-lg bg-white">
            <div class="flex justify-between items-start border-b pb-4 mb-4">
                <div>
                    <h3 class="text-2xl font-bold text-gray-900" id="modalDate">Date</h3>
                    <p class="text-gray-600" id="modalSite">Site info</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-3xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 gap-2 max-h-[60vh] overflow-y-auto pr-2" id="modalScores"></div>
            <div class="mt-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <h4 class="font-bold text-xs text-yellow-800 uppercase mb-2">Evaluator Notes</h4>
                <p id="modalComments" class="text-gray-800 italic text-sm">No comments.</p>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300 font-bold">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = localStorage.getItem('bresa_api_url');

        // THE 16 SKILLS
        const SKILLS = [
            "Punctual", "Prepared", "Hygiene/Dress", "Task Initiation", 
            "Work Rate", "Logical Order", "Adaptability", "Quality Standards", 
            "Clean Workspace", "Awareness/Safety", "Social Interactions", "Communication", 
            "Constructive Criticism", "Positive Attitude", "Asks for Help", "Self-Reflection"
        ];

        let allEntries = [];
        let students = [];
        let filteredEntries = []; 
        let chartInstance = null;

        async function init() {
            if(!API_URL) return alert("API Not Connected");
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = firstDay;

            try {
                const sRes = await fetch(API_URL + "?action=getStudents");
                const sData = await sRes.json();
                students = sData.data;
                
                const sel = document.getElementById('studentSelect');
                sel.innerHTML = '<option value="">Select a Student...</option>';
                students.forEach(s => {
                    sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });

                const eRes = await fetch(API_URL + "?action=getEntries");
                const eData = await eRes.json();
                allEntries = eData.data;

                const sites = [...new Set(allEntries.map(e => e.job_site).filter(s => s))].sort();
                const siteSel = document.getElementById('siteFilter');
                sites.forEach(s => {
                    siteSel.innerHTML += `<option value="${s}">${s}</option>`;
                });
            } catch(e) { console.error("Error loading data", e); }
        }

        function loadStudentData() {
            const sid = document.getElementById('studentSelect').value;
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const siteFilter = document.getElementById('siteFilter').value;

            if(!sid) { document.getElementById('reportContainer').classList.add('hidden'); return; }

            const student = students.find(s => s.student_id == sid);
            document.getElementById('studentName').innerText = student.name;
            document.getElementById('dateRangeDisplay').innerText = `${new Date(startStr).toLocaleDateString()} - ${new Date(endStr).toLocaleDateString()}`;
            document.getElementById('siteDisplay').innerText = siteFilter;
            document.getElementById('reportContainer').classList.remove('hidden');

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            endDate.setHours(23,59,59);

            filteredEntries = allEntries.filter(e => {
                const eDate = new Date(e.date);
                const isStudent = e.student_id == sid;
                const isDate = eDate >= startDate && eDate <= endDate;
                const isSite = siteFilter === "All" || e.job_site === siteFilter;
                return isStudent && isDate && isSite;
            });
            
            filteredEntries.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let sums = new Array(16).fill(0);
            let counts = new Array(16).fill(0);
            let grandSum = 0, grandCount = 0;

            filteredEntries.forEach(entry => {
                entry.scores.forEach((score, idx) => {
                    if(score !== "" && score !== null) {
                        const num = Number(score);
                        sums[idx] += num;
                        counts[idx]++;
                        grandSum += num;
                        grandCount++;
                    }
                });
            });

            const averages = sums.map((s, i) => counts[i] ? (s / counts[i]).toFixed(1) : 0);
            const overall = grandCount ? (grandSum / grandCount).toFixed(2) : "N/A";
            
            const ovDiv = document.getElementById('overallScore');
            ovDiv.innerText = overall;
            ovDiv.className = "text-5xl font-bold leading-none " + (overall >= 3 ? "text-green-600" : (overall >= 2 ? "text-yellow-600" : "text-red-600"));

            renderBarChart(averages);
            renderGrid(averages, counts);
            renderTable(filteredEntries);
        }

        function renderBarChart(averages) {
            const ctx = document.getElementById('skillsChart');
            if(chartInstance) chartInstance.destroy();

            const bgColors = averages.map(s => {
                if(s >= 3.0) return '#10B981'; 
                if(s >= 2.0) return '#F59E0B'; 
                return '#EF4444'; 
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: SKILLS,
                    datasets: [{
                        label: 'Avg',
                        data: averages,
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        x: { min: 0, max: 4, ticks: { stepSize: 1 } },
                        y: { ticks: { font: {weight: 'bold', size: 11} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderGrid(avgs, counts) {
            const grid = document.getElementById('skillsGrid');
            grid.innerHTML = '';
            SKILLS.forEach((skill, i) => {
                let colorClass = "bg-gray-50 border-gray-200 text-gray-800";
                
                if(counts[i] > 0) {
                    if(avgs[i] >= 3) colorClass = "bg-green-50 border-green-200 text-green-800";
                    else if(avgs[i] >= 2) colorClass = "bg-yellow-50 border-yellow-200 text-yellow-800";
                    else colorClass = "bg-red-50 border-red-200 text-red-800";
                }

                grid.innerHTML += `
                    <div class="border rounded p-3 flex flex-col justify-between ${colorClass}">
                        <span class="text-xs font-bold uppercase tracking-wide opacity-75 truncate" title="${skill}">${skill}</span>
                        <div class="mt-2 flex justify-between items-end">
                            <span class="text-2xl font-bold">${avgs[i]}</span>
                            <span class="text-[10px] opacity-60">${counts[i]} logs</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderTable(entries) {
            const tbody = document.getElementById('entriesTable');
            tbody.innerHTML = '';
            
            entries.forEach((e, index) => {
                let s = 0, c = 0;
                e.scores.forEach(v => { if(v!=="") { s+=Number(v); c++; }});
                const avg = c ? (s/c).toFixed(1) : "-";
                
                let avgBadge = "bg-gray-100 text-gray-600";
                if(avg >= 3) avgBadge = "bg-green-100 text-green-800 font-bold";
                else if(avg >= 2) avgBadge = "bg-yellow-100 text-yellow-800 font-bold";
                else if(avg > 0) avgBadge = "bg-red-100 text-red-800 font-bold";

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-3 font-medium text-gray-700 whitespace-nowrap">${new Date(e.date).toLocaleDateString()}</td>
                        <td class="p-3 text-indigo-700 font-medium whitespace-nowrap">${e.job_site || "-"}</td>
                        <td class="p-3 text-gray-500 text-xs whitespace-nowrap">${e.evaluator}</td>
                        <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs ${avgBadge}">${avg}</span></td>
                        <td class="p-3 text-gray-500 italic text-xs leading-tight min-w-[200px]">${e.comments}</td>
                        <td class="p-3 text-right no-print whitespace-nowrap">
                            <button onclick="openModal(${index})" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold uppercase border border-indigo-200 px-2 py-1 rounded hover:bg-indigo-50">View Details</button>
                        </td>
                    </tr>
                `;
            });

            if(entries.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No records found.</td></tr>';
        }

        // --- MODAL LOGIC ---
        function openModal(index) {
            const entry = filteredEntries[index];
            document.getElementById('modalDate').innerText = new Date(entry.date).toLocaleDateString();
            document.getElementById('modalSite').innerText = `${entry.job_site} | ${entry.evaluator}`;
            document.getElementById('modalComments').innerText = entry.comments || "No comments.";
            const grid = document.getElementById('modalScores');
            grid.innerHTML = '';
            
            const descMap = { "0":"Unsatisfactory", "1":"Poor", "2":"Satisfactory", "3":"Good", "4":"Exceptional" };

            SKILLS.forEach((skill, i) => {
                const score = entry.scores[i];
                let color = "bg-gray-50";
                if(score==4) color="bg-green-100"; else if(score==3) color="bg-green-50"; else if(score==2) color="bg-yellow-50"; else if(score<=1 && score!==null && score!=="") color="bg-red-50";
                
                grid.innerHTML += `
                    <div class="flex justify-between items-center p-2 rounded border border-gray-100 ${color}">
                        <span class="text-sm font-medium w-2/3 truncate">${skill}</span>
                        <div class="text-right">
                            <span class="font-bold">${score||"-"}</span>
                            <span class="text-[10px] block opacity-70">${descMap[score]||""}</span>
                        </div>
                    </div>`;
            });
            document.getElementById('entryModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('entryModal').classList.add('hidden'); }
        window.onclick = function(e) { if(e.target == document.getElementById('entryModal')) closeModal(); }

        init();
    </script>
</body>
</html>
