<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .card { border: 1px solid #ddd; box-shadow: none; break-inside: avoid; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans min-h-screen">

    <nav class="bg-blue-900 text-white shadow-lg no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-yellow-400">analytics</span>
                    <span class="font-bold text-xl tracking-tight">Vocational Reports</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">assignment</span> Entry Form
                    </a>
                    <a href="admin.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">settings</span> Admin
                    </a>
                    <button onclick="window.print()" class="bg-white text-blue-900 font-bold px-4 py-2 rounded hover:bg-blue-50 transition flex items-center gap-1 text-sm shadow">
                        <span class="material-icons text-sm">print</span> Print
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="errorBanner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="material-icons">error_outline</span> Connection Error
            </h3>
            <p id="errorText">Could not load data.</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8 no-print">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Student</label>
                    <div class="relative">
                        <select id="studentSelect" onchange="updateDashboard()" class="w-full p-3 pl-10 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                            <option value="">Loading students...</option>
                        </select>
                        <span class="material-icons absolute left-3 top-3 text-slate-400">person_search</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Time Period</label>
                    <div class="relative">
                        <select id="timeRange" onchange="updateDashboard()" class="w-full p-3 pl-10 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="180">Last 6 Months</option>
                            <option value="all">All Time</option>
                        </select>
                        <span class="material-icons absolute left-3 top-3 text-slate-400">calendar_today</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-slate-500 font-medium">Syncing with database...</p>
        </div>

        <div id="reportContent" class="hidden space-y-8">
            
            <div class="flex justify-between items-end border-b border-slate-300 pb-4">
                <div>
                    <h1 id="studentNameTitle" class="text-4xl font-bold text-slate-800">Student Name</h1>
                    <p class="text-slate-500 mt-1">Vocational Skills Progress Report</p>
                </div>
                <div class="text-right text-xs text-slate-400">
                    Generated: <span id="reportDate" class="font-mono text-slate-600"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 card">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-full bg-blue-50 text-blue-600">
                            <span class="material-icons text-3xl">history_edu</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">Evaluations</p>
                            <p id="totalLogs" class="text-3xl font-bold text-slate-800">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 card">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-full bg-green-50 text-green-600">
                            <span class="material-icons text-3xl">show_chart</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">Avg Score (0-4)</p>
                            <p id="avgScore" class="text-3xl font-bold text-slate-800">0.0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 card">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-full bg-purple-50 text-purple-600">
                            <span class="material-icons text-3xl">military_tech</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">Strongest Skill</p>
                            <p id="topSkill" class="text-lg font-bold text-slate-800 leading-tight">N/A</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card">
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="material-icons text-slate-400">bar_chart</span> Skill Proficiency Profile
                </h3>
                <div class="relative h-[500px] w-full">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-icons text-slate-400">comment</span> Recent Feedback
                    </h3>
                </div>
                <div class="p-6">
                    <ul id="commentsList" class="space-y-4">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION (Matches Entry Page)
        const SKILLS_LIST = [
            "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
            "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
            "Demonstrates adaptability", "Work is completed to quality standards", "Maintains clean and organized work space",
            "Awareness of surroundings and good decision making", "Appropriate and respectful social interactions",
            "Displays effective communication skills", "Accepts constructive criticism", "Demonstrates a positive attitude",
            "Asks for help appropriately", "Demonstrates self-reflection"
        ];

        let allEntries = [];
        let studentsMap = {};
        let chartInstance = null;

        // 2. DATE PARSER (Fixes Timezone Bug)
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            // Expects "YYYY-MM-DD"
            const cleanStr = dateStr.substring(0, 10);
            const parts = cleanStr.split('-');
            // Create Local Date (Year, MonthIndex, Day)
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        // 3. INITIALIZATION
        window.addEventListener('load', async () => {
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
            
            let apiUrl = localStorage.getItem('vocational_backend_url');
            if (apiUrl) apiUrl = apiUrl.trim().replace(/['"]+/g, '');

            if (!apiUrl) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                showError("No database connected.", "Please go to Admin or the Entry page to connect.");
                return;
            }

            try {
                // Cache Buster
                const t = Date.now();
                
                const [sRes, eRes] = await Promise.all([
                    fetch(`${apiUrl}?action=getStudents&t=${t}`),
                    fetch(`${apiUrl}?action=getEntries&t=${t}`)
                ]);

                const sData = await sRes.json();
                const eData = await eRes.json();

                if (sData.status === 'error' || eData.status === 'error') throw new Error("Database Error");

                // Populate Students
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">-- Select a Student --</option>';
                sData.data.forEach(s => {
                    studentsMap[s.student_id] = s.name;
                    select.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });

                allEntries = eData.data;
                document.getElementById('loadingIndicator').classList.add('hidden');

            } catch (err) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                showError("Connection Failed", "Could not reach Google Sheets.");
                console.error(err);
            }
        });

        // 4. UPDATE DASHBOARD
        function updateDashboard() {
            const studentId = document.getElementById('studentSelect').value;
            const range = document.getElementById('timeRange').value;
            const container = document.getElementById('reportContent');

            if (!studentId) {
                container.classList.add('hidden');
                return;
            }

            // Set Title
            document.getElementById('studentNameTitle').innerText = studentsMap[studentId];
            container.classList.remove('hidden');

            // Filter Data
            const today = new Date();
            today.setHours(0,0,0,0);
            const cutoffDate = new Date(today);
            
            if (range !== 'all') {
                cutoffDate.setDate(today.getDate() - parseInt(range));
            }

            const filtered = allEntries.filter(e => {
                if(e.student_id.toString() !== studentId) return false;
                if(range === 'all') return true;
                const entryDate = parseDate(e.date);
                return entryDate >= cutoffDate;
            });

            if (filtered.length === 0) {
                showEmptyState();
                return;
            }

            // Calculate Stats
            let skillSums = {};
            let skillCounts = {};
            SKILLS_LIST.forEach(s => { skillSums[s] = 0; skillCounts[s] = 0; });
            let grandSum = 0, grandCount = 0;

            filtered.forEach(entry => {
                SKILLS_LIST.forEach(skill => {
                    const score = parseFloat(entry.scores[skill]);
                    if (!isNaN(score)) {
                        skillSums[skill] += score;
                        skillCounts[skill]++;
                        grandSum += score;
                        grandCount++;
                    }
                });
            });

            // Update Metrics
            document.getElementById('totalLogs').innerText = filtered.length;
            document.getElementById('avgScore').innerText = grandCount ? (grandSum / grandCount).toFixed(1) : "0.0";

            // Prepare Chart Data
            let labels = [], data = [], bestAvg = -1, bestName = "N/A";
            
            SKILLS_LIST.forEach(skill => {
                const avg = skillCounts[skill] ? (skillSums[skill] / skillCounts[skill]) : 0;
                labels.push(skill);
                data.push(avg.toFixed(1));
                if (avg > bestAvg && avg > 0) { bestAvg = avg; bestName = skill; }
            });
            document.getElementById('topSkill').innerText = bestName;

            renderChart(labels, data);

            // Render Comments
            renderComments(filtered);
        }

        function showEmptyState() {
            document.getElementById('totalLogs').innerText = "0";
            document.getElementById('avgScore').innerText = "-";
            document.getElementById('topSkill').innerText = "-";
            document.getElementById('commentsList').innerHTML = "<li class='text-slate-400 italic text-center py-4'>No records found for this period.</li>";
            if(chartInstance) chartInstance.destroy();
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('skillsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            // Color Coding based on Rubric (Green=4, Blue=3, Yellow=2, Orange=1, Red=0)
            const bgColors = data.map(val => {
                if(val >= 3.5) return 'rgba(22, 163, 74, 0.7)'; // Green
                if(val >= 2.5) return 'rgba(37, 99, 235, 0.7)'; // Blue
                if(val >= 1.5) return 'rgba(202, 138, 4, 0.7)'; // Yellow
                if(val >= 0.5) return 'rgba(234, 88, 12, 0.7)'; // Orange
                return 'rgba(220, 38, 38, 0.7)'; // Red
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Score',
                        data: data,
                        backgroundColor: bgColors,
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 4, grid: { color: '#e2e8f0' }, title: {display: true, text: 'Score (0 - 4)'} },
                        y: { grid: { display: false }, ticks: { autoSkip: false, font: {size: 11} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderComments(entries) {
            const list = document.getElementById('commentsList');
            list.innerHTML = "";
            
            // Sort Date Descending
            const sorted = entries.sort((a,b) => parseDate(b.date) - parseDate(a.date)).slice(0, 5);

            sorted.forEach(e => {
                if (e.comments && e.comments.trim() !== "") {
                    const d = parseDate(e.date);
                    const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
                    
                    const li = document.createElement('li');
                    li.className = "border-b border-slate-100 last:border-0 pb-3";
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${dateStr}</span>
                            <span class="text-xs text-slate-400 font-bold uppercase">${e.job_site}</span>
                        </div>
                        <p class="text-sm text-slate-700 italic">"${e.comments}"</p>
                        <p class="text-xs text-right text-slate-400 mt-1">- ${e.evaluator}</p>
                    `;
                    list.appendChild(li);
                }
            });
            if (!list.innerHTML) list.innerHTML = "<li class='text-slate-400 italic text-center py-4'>No written comments recorded.</li>";
        }

        function showError(title, detail) {
            document.getElementById('errorBanner').classList.remove('hidden');
            document.getElementById('errorText').innerText = detail;
        }
    </script>
</body>
</html>
