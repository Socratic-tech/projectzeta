<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Vocational Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            @page { margin: 0.5in; size: landscape; }
            body { background-color: white; }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .shadow, .shadow-lg { box-shadow: none !important; }
            /* Force graph to fit */
            canvas { max-height: 400px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans p-6">

    <div class="max-w-6xl mx-auto flex justify-between items-center mb-6 no-print">
        <h1 class="text-3xl font-bold text-gray-800">Vocational Reports</h1>
        <div class="space-x-4">
            <a href="home.html" class="text-indigo-600 hover:underline">Dashboard</a>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white p-5 rounded shadow mb-6 no-print">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Student</label>
                <select id="studentSelect" onchange="loadStudentData()" class="w-full border p-2 rounded bg-gray-50">
                    <option value="">Select Student...</option>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Start Date</label>
                <input type="date" id="startDate" onchange="loadStudentData()" class="w-full border p-2 rounded">
            </div>
            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">End Date</label>
                <input type="date" id="endDate" onchange="loadStudentData()" class="w-full border p-2 rounded">
            </div>

            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Job Site</label>
                <select id="siteFilter" onchange="loadStudentData()" class="w-full border p-2 rounded">
                    <option value="All">All Sites</option>
                </select>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t flex justify-end">
            <button onclick="window.print()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-bold">
                Print Report
            </button>
        </div>
    </div>

    <div id="reportContainer" class="max-w-6xl mx-auto bg-white p-8 rounded shadow hidden">
        
        <div class="flex justify-between items-end border-b pb-4 mb-6">
            <div>
                <h2 id="studentName" class="text-3xl font-bold text-indigo-900">Student Name</h2>
                <p class="text-gray-500">
                    Range: <span id="dateRangeDisplay">All Time</span> | 
                    Site: <span id="siteDisplay">All</span>
                </p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500 uppercase tracking-wide">Average Score</div>
                <div id="overallScore" class="text-5xl font-bold text-gray-800">--</div>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="font-bold text-lg mb-2 text-gray-700">Skill Proficiency Breakdown</h3>
            <div class="relative h-96 w-full">
                <canvas id="skillsChart"></canvas>
            </div>
        </div>

        <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">Skill Details</h3>
        <div id="skillsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-sm">
            </div>

        <div class="print-break">
            <h3 class="font-bold text-lg mb-4 text-gray-700 border-b pb-2">Session History</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b text-gray-600 uppercase">
                            <th class="p-2">Date</th>
                            <th class="p-2">Job Site</th>
                            <th class="p-2">Evaluator</th>
                            <th class="p-2">Avg</th>
                            <th class="p-2 w-1/3">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = localStorage.getItem('bresa_api_url');

        // THE 16 SKILLS
        const SKILLS = [
            "Punctual", "Prepared", "Hygiene/Dress", "Task Initiation", 
            "Work Rate", "Logical Order", "Adaptability", "Quality Standards", 
            "Clean Workspace", "Awareness/Safety", "Social Interactions", "Communication", 
            "Constructive Criticism", "Positive Attitude", "Asks for Help", "Self-Reflection"
        ];

        let allEntries = [];
        let students = [];
        let chartInstance = null;

        async function init() {
            if(!API_URL) return alert("API Not Connected");
            
            // Set Default Dates (First of current month to Today)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = firstDay;

            // Fetch Data
            const sRes = await fetch(API_URL + "?action=getStudents");
            const sData = await sRes.json();
            students = sData.data;
            
            const sel = document.getElementById('studentSelect');
            sel.innerHTML = '<option value="">Select a Student...</option>';
            students.forEach(s => {
                sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
            });

            const eRes = await fetch(API_URL + "?action=getEntries");
            const eData = await eRes.json();
            allEntries = eData.data;
            
            // Populate Job Site Filter based on actual data
            const sites = [...new Set(allEntries.map(e => e.job_site).filter(s => s))].sort();
            const siteSel = document.getElementById('siteFilter');
            sites.forEach(s => {
                siteSel.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function loadStudentData() {
            const sid = document.getElementById('studentSelect').value;
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const siteFilter = document.getElementById('siteFilter').value;

            if(!sid) { document.getElementById('reportContainer').classList.add('hidden'); return; }

            // UPDATE HEADER
            const student = students.find(s => s.student_id == sid);
            document.getElementById('studentName').innerText = student.name;
            document.getElementById('dateRangeDisplay').innerText = `${startStr} to ${endStr}`;
            document.getElementById('siteDisplay').innerText = siteFilter;
            document.getElementById('reportContainer').classList.remove('hidden');

            // FILTER ENTRIES
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            // Set time to end of day for the end date
            endDate.setHours(23,59,59);

            const filtered = allEntries.filter(e => {
                const eDate = new Date(e.date);
                const isStudent = e.student_id == sid;
                const isDate = eDate >= startDate && eDate <= endDate;
                const isSite = siteFilter === "All" || e.job_site === siteFilter;
                return isStudent && isDate && isSite;
            });
            
            // CALCULATE AVERAGES
            let sums = new Array(16).fill(0);
            let counts = new Array(16).fill(0);
            let grandSum = 0;
            let grandCount = 0;

            filtered.forEach(entry => {
                entry.scores.forEach((score, idx) => {
                    if(score !== "" && score !== null) {
                        const num = Number(score);
                        sums[idx] += num;
                        counts[idx]++;
                        grandSum += num;
                        grandCount++;
                    }
                });
            });

            const averages = sums.map((s, i) => counts[i] ? (s / counts[i]).toFixed(1) : 0);
            const overall = grandCount ? (grandSum / grandCount).toFixed(2) : "N/A";
            
            // Color Logic for Overall
            const ovDiv = document.getElementById('overallScore');
            ovDiv.innerText = overall;
            ovDiv.className = "text-5xl font-bold " + (overall >= 3 ? "text-green-600" : (overall >= 2 ? "text-yellow-600" : "text-red-600"));

            renderBarChart(averages);
            renderGrid(averages, counts);
            renderTable(filtered);
        }

        function renderBarChart(averages) {
            const ctx = document.getElementById('skillsChart');
            if(chartInstance) chartInstance.destroy();

            // Dynamic Colors based on score
            const bgColors = averages.map(s => {
                if(s >= 3.5) return '#10B981'; // Green
                if(s >= 2.5) return '#FBBF24'; // Yellow
                return '#EF4444'; // Red
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: SKILLS,
                    datasets: [{
                        label: 'Average Score',
                        data: averages,
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // MAKES IT HORIZONTAL
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 4, ticks: { stepSize: 1 } },
                        y: { ticks: { autoSkip: false, font: {size: 11} } } // Ensure all labels show
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderGrid(avgs, counts) {
            const grid = document.getElementById('skillsGrid');
            grid.innerHTML = '';
            SKILLS.forEach((skill, i) => {
                let color = "text-gray-400";
                if(counts[i] > 0) {
                    if(avgs[i] >= 3) color = "text-green-600";
                    else if(avgs[i] >= 2) color = "text-yellow-600";
                    else color = "text-red-600";
                }

                grid.innerHTML += `
                    <div class="border p-2 rounded flex justify-between items-center bg-gray-50">
                        <span class="truncate mr-2" title="${skill}">${skill}</span>
                        <div class="text-right">
                            <span class="font-bold ${color} text-lg">${avgs[i]}</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderTable(entries) {
            const tbody = document.getElementById('entriesTable');
            tbody.innerHTML = '';
            // Sort by Date Descending
            const sorted = [...entries].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(e => {
                let s = 0, c = 0;
                e.scores.forEach(v => { if(v!=="") { s+=Number(v); c++; }});
                const avg = c ? (s/c).toFixed(1) : "-";

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2 text-gray-800 font-medium">${new Date(e.date).toLocaleDateString()}</td>
                        <td class="p-2 text-indigo-700">${e.job_site || "-"}</td>
                        <td class="p-2 text-gray-500 text-xs">${e.evaluator}</td>
                        <td class="p-2 font-bold">${avg}</td>
                        <td class="p-2 text-gray-500 italic text-xs">${e.comments}</td>
                    </tr>
                `;
            });

            if(entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">No records found for this period.</td></tr>';
            }
        }

        init();
    </script>
</body>
</html>
