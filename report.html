<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Reports - Berrien RESA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .ts-control { border-radius: 0.5rem; padding: 0.75rem; border-color: #d1d5db; }
        @media print {
            body * { visibility: hidden; }
            #reportCardModal, #reportCardModal * { visibility: visible; }
            #reportCardModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-[#F3F4F6] text-gray-900">

    <nav class="bg-white border-b border-gray-200 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <img src="https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_1/v1688065006/berrienresaorg/us2um9v88w7rv6ublprl/berrien-resa-logo.png" alt="Berrien RESA" class="h-10 w-auto">
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="home.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                        <a href="entry.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Entry</a>
                        <a href="report.html" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Reports</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8 no-print">
        
        <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold leading-tight text-indigo-900">Student Reports</h1>
                <p class="mt-2 text-sm text-gray-600">Select a student to view performance history and trends.</p>
            </div>
            <div class="w-full md:w-1/3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Student</label>
                <select id="studentSelect" placeholder="Type to search name..."></select>
            </div>
        </div>

        <div id="emptyState" class="text-center py-20 bg-white rounded-lg shadow-sm border border-gray-200 border-dashed">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No student selected</h3>
            <p class="mt-1 text-sm text-gray-500">Use the search box above to load student data.</p>
        </div>

        <div id="dashboard" class="hidden space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white overflow-hidden shadow rounded-lg px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">Total Entries</dt>
                    <dd class="mt-1 text-3xl font-semibold text-gray-900" id="statCount">0</dd>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">Overall Average</dt>
                    <dd class="mt-1 text-3xl font-semibold text-indigo-600" id="statAvg">0.0</dd>
                </div>
                <div class="bg-white overflow-hidden shadow rounded-lg px-4 py-5 sm:p-6 flex items-center justify-center">
                    <button onclick="openReportCard()" class="w-full h-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition">
                        ðŸ“„ Generate Official Report
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Performance Trend</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Habit Breakdown</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="skillsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Comments Log</h3>
                </div>
                <ul id="commentsList" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                    </ul>
            </div>
        </div>
    </div>

    <div id="reportCardModal" class="fixed z-50 inset-0 overflow-y-auto hidden bg-white">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-3xl border-2 border-gray-800 p-8 shadow-2xl relative">
                <button onclick="closeReportCard()" class="no-print absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">Close</button>
                <button onclick="window.print()" class="no-print absolute top-4 right-20 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded">Print Report</button>
                
                <div class="text-center border-b-2 border-gray-800 pb-4 mb-6">
                    <div class="flex justify-center mb-4">
                        <img src="https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_1/v1688065006/berrienresaorg/us2um9v88w7rv6ublprl/berrien-resa-logo.png" alt="Berrien RESA" class="h-20 w-auto">
                    </div>
                    <h1 class="text-3xl font-serif font-bold text-gray-900">Student Progress Report</h1>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div><p class="text-gray-500">Student Name</p><p class="font-bold text-lg" id="rcName">--</p></div>
                    <div><p class="text-gray-500">Student ID</p><p class="font-bold text-lg" id="rcId">--</p></div>
                    <div><p class="text-gray-500">Report Date</p><p class="font-bold" id="rcDate">--</p></div>
                    <div><p class="text-gray-500">Total Entries</p><p class="font-bold" id="rcCount">--</p></div>
                </div>

                <div class="mb-8 bg-indigo-50 border-l-4 border-indigo-500 p-4">
                    <h3 class="text-indigo-900 font-bold mb-2">Teacher's Executive Summary</h3>
                    <p id="rcAutoSummary" class="text-gray-700 leading-relaxed text-sm">Generating...</p>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold border-b border-gray-300 mb-4 pb-1">Performance Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4" id="rcGrid"></div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold border-b border-gray-300 mb-4 pb-1">Recent Teacher Comments</h3>
                    <div id="rcComments" class="space-y-3 text-sm text-gray-700 italic bg-gray-50 p-4 rounded border border-gray-100 min-h-[4rem]"></div>
                </div>

                <div class="mt-8 pt-8 flex justify-between">
                    <div class="border-t border-gray-400 w-1/3 text-center text-sm text-gray-500">Teacher Signature</div>
                    <div class="border-t border-gray-400 w-1/3 text-center text-sm text-gray-500">Parent Signature</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = localStorage.getItem('bresa_api_url');
        if (!API_URL) alert("System not connected. Please go to Admin Dashboard to setup.");
        
        // VARS
        let allEntries = [];
        let trendChartInstance = null;
        let skillsChartInstance = null;
        let currentStudent = null;
        const habitNames = ["Self-Reflection", "Time Mgmt", "Organization", "Task Comp", "Attention", "Follow Directions", "Problem Solving", "Independence", "Cooperation", "Social Skills", "Quality", "Pace"];
        
        // Default settings (can be fetched from API if needed, hardcoded for speed here)
        const appSettings = { low: 2.5, high: 3.8 };

        // INIT
        async function init() {
            try {
                // Load Students for Dropdown
                const sRes = await fetch(API_URL + "?action=getStudents");
                const sData = await sRes.json();
                
                const selectEl = document.getElementById('studentSelect');
                selectEl.innerHTML = '<option value="">Select a student...</option>';
                sData.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.student_id;
                    opt.innerText = s.name;
                    selectEl.appendChild(opt);
                });

                new TomSelect("#studentSelect", {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    onChange: (value) => { loadStudentData(value, sData.data); }
                });

                // Load Entries Background
                const eRes = await fetch(API_URL + "?action=getEntries");
                const eData = await eRes.json();
                allEntries = eData.data || [];

            } catch (error) { console.error("Error loading data", error); }
        }

        function loadStudentData(studentId, studentList) {
            if(!studentId) {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            // Find student details
            currentStudent = studentList.find(s => s.student_id == studentId);
            const entries = allEntries.filter(e => e.student_id == studentId).sort((a,b) => new Date(a.date) - new Date(b.date));

            // UI Toggle
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // 1. Stats
            document.getElementById('statCount').innerText = entries.length;
            const globalAvg = calculateOverallAvg(entries);
            document.getElementById('statAvg').innerText = globalAvg;

            // 2. Charts
            renderCharts(entries);

            // 3. Comments List (With Evaluator Support)
            renderComments(entries);
        }

        function calculateSmartAverage(arr) {
            let sum=0, count=0;
            arr.forEach(v=>{if(v){sum+=Number(v); count++;}});
            return count===0?0:sum/count;
        }

        function calculateOverallAvg(entries) {
            let sum=0, count=0;
            entries.forEach(e => {
                e.scores.forEach(s => { if(s){ sum+=Number(s); count++; }});
            });
            return count===0 ? "0.0" : (sum/count).toFixed(1);
        }

        function renderCharts(entries) {
            const dates = entries.map(e => new Date(e.date).toLocaleDateString());
            const dailyAverages = entries.map(e => calculateSmartAverage(e.scores).toFixed(1));

            // Bucket skills
            const skillBuckets = Array.from({ length: 12 }, () => []);
            entries.forEach(e => { e.scores.forEach((s, i) => { if(s) skillBuckets[i].push(s); }); });
            const skillAverages = skillBuckets.map(b => calculateSmartAverage(b).toFixed(1));
            
            // Colors
            const barColors = skillAverages.map(s => s >= appSettings.high ? '#10B981' : s > appSettings.low ? '#F59E0B' : '#EF4444');

            // Trend Chart
            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'Daily Avg', data: dailyAverages, borderColor: '#4F46E5', tension: 0.3, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 1, max: 5 } } }
            });

            // Skills Chart
            if(skillsChartInstance) skillsChartInstance.destroy();
            skillsChartInstance = new Chart(document.getElementById('skillsChart'), {
                type: 'bar',
                data: { labels: habitNames, datasets: [{ label: 'Average', data: skillAverages, backgroundColor: barColors }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { min: 0, max: 5 } } }
            });
        }

        function renderComments(entries) {
            const list = document.getElementById('commentsList');
            list.innerHTML = '';
            
            // Reverse order for comments (newest first)
            const reversed = [...entries].reverse();
            const commentsOnly = reversed.filter(e => e.comments && e.comments.trim() !== "");

            if(commentsOnly.length === 0) {
                list.innerHTML = '<li class="px-4 py-4 text-sm text-gray-500 text-center">No comments recorded yet.</li>';
                return;
            }

            commentsOnly.forEach(e => {
                const dateStr = new Date(e.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                // NEW: Handle Evaluator Name
                const evaluatorDisplay = e.evaluator ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">${e.evaluator}</span>` : '';

                const li = document.createElement('li');
                li.className = 'px-4 py-4';
                li.innerHTML = `
                    <div class="flex space-x-3">
                        <div class="flex-1 space-y-1">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-medium text-gray-900">${dateStr} ${evaluatorDisplay}</h3>
                            </div>
                            <p class="text-sm text-gray-500">"${e.comments}"</p>
                        </div>
                    </div>`;
                list.appendChild(li);
            });
        }

        // === REPORT CARD LOGIC (Reused from Admin) ===
        function openReportCard() {
            if(!currentStudent) return;
            const entries = allEntries.filter(e => e.student_id == currentStudent.student_id);

            document.getElementById('rcName').innerText = currentStudent.name;
            document.getElementById('rcId').innerText = currentStudent.student_id;
            document.getElementById('rcDate').innerText = new Date().toLocaleDateString();
            document.getElementById('rcCount').innerText = entries.length + " entries";
            
            // Auto Summary
            document.getElementById('rcAutoSummary').innerHTML = generateSummaryText(currentStudent.name, entries);

            // Grid
            const skillBuckets = Array.from({ length: 12 }, () => []);
            entries.forEach(e => { e.scores.forEach((s, i) => { if(s) skillBuckets[i].push(s); }); });
            const grid = document.getElementById('rcGrid'); grid.innerHTML = '';

            habitNames.forEach((n, i) => {
                const avg = calculateSmartAverage(skillBuckets[i]);
                const disp = avg > 0 ? avg.toFixed(1) : "N/A";
                let c = "text-gray-400", b = "bg-gray-100", w = "0%";
                if(avg > 0) { 
                    w=(avg/5*100)+"%"; 
                    if(avg>=appSettings.high){c="text-green-700";b="bg-green-500"} 
                    else if(avg>appSettings.low){c="text-yellow-600";b="bg-yellow-400"} 
                    else{c="text-red-600";b="bg-red-500"} 
                }
                grid.innerHTML += `<div class="flex items-center justify-between border-b pb-2"><div class="w-1/3 text-sm font-medium">${n}</div><div class="w-1/3 px-2"><div class="h-2 w-full bg-gray-200 rounded-full"><div class="h-full ${b}" style="width:${w}"></div></div></div><div class="w-1/6 text-right font-bold ${c}">${disp}</div></div>`;
            });

            // Comments on Report Card
            const commentsDiv = document.getElementById('rcComments'); commentsDiv.innerHTML = "";
            const recent = entries.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).filter(e=>e.comments).slice(0,3);
            if(recent.length>0) recent.forEach(e => {
                const evalName = e.evaluator ? `<strong>${e.evaluator}:</strong> ` : "";
                commentsDiv.innerHTML += `<p class="mb-1"><span class="text-xs font-bold text-gray-500 mr-2">[${new Date(e.date).toLocaleDateString()}]</span> ${evalName}${e.comments}</p>`;
            });
            else commentsDiv.innerHTML = "<p class='text-gray-400'>No comments.</p>";

            document.getElementById('reportCardModal').classList.remove('hidden');
        }

        function closeReportCard() { document.getElementById('reportCardModal').classList.add('hidden'); }

        function generateSummaryText(name, entries) {
            const habitTotals = new Array(12).fill(0); const habitCounts = new Array(12).fill(0);
            entries.forEach(e => { e.scores.forEach((s, i) => { if(s){ habitTotals[i]+=Number(s); habitCounts[i]++; }})});
            const habitResults = habitNames.map((n, i) => ({name: n, avg: habitCounts[i]>0?habitTotals[i]/habitCounts[i]:0})).filter(h=>h.avg>0).sort((a,b)=>b.avg-a.avg);
            if(habitResults.length===0) return "No data available to generate summary.";
            
            const top = habitResults.slice(0, 3); const bottom = habitResults.slice(-2).reverse();
            const overall = (habitResults.reduce((a,b)=>a+b.avg,0)/habitResults.length).toFixed(1);
            let s = ""; const fName = name.split(' ')[0];
            
            if(overall >= appSettings.high) s += `<strong>${fName}</strong> has demonstrated outstanding performance (Avg: ${overall}). `;
            else if(overall > appSettings.low) s += `<strong>${fName}</strong> has shown consistent effort (Avg: ${overall}). `;
            else s += `<strong>${fName}</strong> has faced challenges recently (Avg: ${overall}). `;
            
            s += `Strengths include <strong>${top[0].name}</strong> and <strong>${top[1].name}</strong>. `;
            if(bottom[0].avg <= appSettings.low) s += `Focus is recommended on: <strong>${bottom[0].name}</strong>.`;
            else s += `Skills are generally well-rounded.`;
            return s;
        }

        init();
    </script>
</body>
</html>
