<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: ui-sans-serif, system-ui, sans-serif; }
        
        /* Print Optimization */
        @media print {
            @page { size: landscape; margin: 0.5cm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            nav, .no-print, #filterBar { display: none !important; }
            #reportContainer { box-shadow: none; border: none; padding: 0; width: 100%; max-width: 100%; }
            .chart-card { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ddd; }
            #historyTable { display: table !important; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-blue-900 text-white shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-yellow-400">analytics</span>
                    <span class="font-bold text-xl">Vocational Reports</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">assignment</span> Entry
                    </a>
                    <a href="admin.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">settings</span> Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div id="loadingIndicator" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-medium">Loading Database...</p>
    </div>

    <main id="mainContent" class="hidden flex-1 py-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full">

        <div id="filterBar" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Student</label>
                    <select id="studentSelect" onchange="handleStudentChange()" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                    <input type="date" id="startDate" onchange="runReport()" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm text-slate-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label>
                    <input type="date" id="endDate" onchange="runReport()" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm text-slate-600 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Job Site</label>
                    <select id="siteSelect" onchange="runReport()" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                        <option value="All">All Sites</option>
                    </select>
                </div>

                <div class="md:col-span-2 text-right">
                    <button onclick="window.print()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg shadow transition text-sm">
                        Print Report
                    </button>
                </div>
            </div>
        </div>

        <div id="reportContainer" class="space-y-6 hidden">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h1 id="reportStudentName" class="text-4xl font-extrabold text-slate-900 mb-2">Student Name</h1>
                    <div class="text-sm text-slate-500 space-y-1">
                        <p><strong>Report Period:</strong> <span id="reportPeriod"></span></p>
                        <p><strong>Job Site Filter:</strong> <span id="reportSiteFilter">All</span></p>
                        <p><strong>Total Evaluations:</strong> <span id="reportCount">0</span></p>
                    </div>
                </div>

                <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 text-center w-full md:w-64 shrink-0">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Overall Average</p>
                    <div id="overallScoreDisplay" class="text-5xl font-black text-slate-300">N/A</div>
                    <p class="text-xs text-slate-400 mt-2">Scale: 0.0 - 4.0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 chart-card">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2">Skills Profile</h3>
                    <div class="h-64 relative"><canvas id="skillsChart"></canvas></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 chart-card">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2">Progress Over Time</h3>
                    <div class="h-64 relative"><canvas id="trendChart"></canvas></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 chart-card">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2">Support Level Breakdown</h3>
                    <div class="h-64 relative flex justify-center"><canvas id="distributionChart"></canvas></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 chart-card">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2">Performance by Job Site</h3>
                    <div class="h-64 relative"><canvas id="siteChart"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
                    <h3 class="font-bold text-slate-700">Detailed Log</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3">Job Site</th>
                                <th class="px-6 py-3">Evaluator</th>
                                <th class="px-6 py-3">Score</th>
                                <th class="px-6 py-3 w-1/2">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="hidden print:flex justify-between mt-12 pt-8">
                <div class="w-5/12 border-t border-slate-400 pt-2">
                    <p class="font-bold text-slate-900">Teacher Signature</p>
                </div>
                <div class="w-5/12 border-t border-slate-400 pt-2">
                    <p class="font-bold text-slate-900">Parent/Guardian Signature</p>
                </div>
            </div>

        </div>

    </main>

    <script>
        const SKILLS = [
            "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
            "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
            "Demonstrates adaptability", "Work is completed to quality standards", "Maintains clean and organized work space",
            "Awareness of surroundings and good decision making", "Appropriate and respectful social interactions",
            "Displays effective communication skills", "Accepts constructive criticism", "Demonstrates a positive attitude",
            "Asks for help appropriately", "Demonstrates self-reflection"
        ];

        let allEntries = [], students = {};
        // Chart instances
        let charts = { skills: null, trend: null, dist: null, site: null };

        // Helper: Date Formatting
        function parseDate(str) { return new Date(str.replace(/-/g, '\/')); } // Fix browser dash issues
        function toISODate(d) { return d.toISOString().split('T')[0]; }

        window.onload = async () => {
            // Set default dates (1st of current month to today)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('endDate').value = toISODate(today);
            document.getElementById('startDate').value = toISODate(firstDay);

            const url = localStorage.getItem('vocational_backend_url');
            if(!url) return alert("Database not connected. Please go to Admin Setup.");

            try {
                // Fetch Data
                const t = Date.now();
                const [sRes, eRes] = await Promise.all([
                    fetch(`${url}?action=getStudents&t=${t}`), fetch(`${url}?action=getEntries&t=${t}`)
                ]);
                const sData = await sRes.json();
                const eData = await eRes.json();

                // Populate Student Dropdown
                const sel = document.getElementById('studentSelect');
                sData.data.forEach(s => {
                    students[s.student_id] = s.name;
                    sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });

                allEntries = eData.data;

                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch(e) { console.error(e); alert("Failed to load data."); }
        };

        function handleStudentChange() {
            const sid = document.getElementById('studentSelect').value;
            const siteSel = document.getElementById('siteSelect');
            
            // Reset Site Filter
            siteSel.innerHTML = '<option value="All">All Sites</option>';
            siteSel.disabled = !sid;

            if(!sid) {
                document.getElementById('reportContainer').classList.add('hidden');
                return;
            }

            // Populate Sites based on student history
            const studentEntries = allEntries.filter(e => e.student_id == sid);
            const sites = [...new Set(studentEntries.map(e => e.job_site))].sort();
            
            sites.forEach(site => {
                siteSel.innerHTML += `<option value="${site}">${site}</option>`;
            });

            runReport();
        }

        function runReport() {
            const sid = document.getElementById('studentSelect').value;
            if(!sid) return;

            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            const siteFilter = document.getElementById('siteSelect').value;

            // Date Objects for comparison (set times to start/end of day)
            const startD = new Date(startVal); startD.setHours(0,0,0,0);
            const endD = new Date(endVal); endD.setHours(23,59,59,999);

            // Filter Data
            const filtered = allEntries.filter(e => {
                const d = parseDate(e.date);
                const isStudent = e.student_id == sid;
                const isDate = d >= startD && d <= endD;
                const isSite = siteFilter === "All" || e.job_site === siteFilter;
                return isStudent && isDate && isSite;
            });

            updateUI(filtered, students[sid], startVal, endVal, siteFilter);
        }

        function updateUI(data, name, start, end, site) {
            document.getElementById('reportContainer').classList.remove('hidden');
            
            // 1. Header Info
            document.getElementById('reportStudentName').innerText = name;
            document.getElementById('reportPeriod').innerText = `${start} to ${end}`;
            document.getElementById('reportSiteFilter').innerText = site;
            document.getElementById('reportCount').innerText = data.length;

            // 2. Process Data Metrics
            let skillSums = {}, skillCounts = {}, totalSum = 0, totalCount = 0;
            let trendMap = {}, distCounts = {0:0, 1:0, 2:0, 3:0, 4:0};
            let siteSums = {}, siteCounts = {};
            
            SKILLS.forEach(s => { skillSums[s]=0; skillCounts[s]=0; });

            // Table Body
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = "";
            if(data.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-slate-400 italic">No records found for this period.</td></tr>`;

            // Sort newest first for table
            const sortedData = [...data].sort((a,b) => parseDate(b.date) - parseDate(a.date));

            sortedData.forEach(e => {
                let daySum = 0, dayCount = 0;
                
                SKILLS.forEach(s => {
                    const val = parseFloat(e.scores[s]);
                    if(!isNaN(val)) {
                        skillSums[s] += val; skillCounts[s]++;
                        totalSum += val; totalCount++;
                        daySum += val; dayCount++;
                        distCounts[val]++;
                    }
                });

                const dailyAvg = dayCount ? (daySum/dayCount) : 0;
                
                // Trend Data (Key: Date String)
                const dateKey = e.date.substring(0,10);
                if(!trendMap[dateKey]) trendMap[dateKey] = [];
                trendMap[dateKey].push(dailyAvg);

                // Site Data
                if(!siteSums[e.job_site]) { siteSums[e.job_site] = 0; siteCounts[e.job_site] = 0; }
                siteSums[e.job_site] += dailyAvg;
                siteCounts[e.job_site]++;

                // Add Row
                const rowColor = dailyAvg >= 3 ? 'text-green-600' : (dailyAvg >= 2 ? 'text-blue-600' : 'text-orange-600');
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4 font-medium">${dateKey}</td>
                        <td class="px-6 py-4">${e.job_site}</td>
                        <td class="px-6 py-4 text-xs uppercase text-slate-500">${e.evaluator}</td>
                        <td class="px-6 py-4 font-bold ${rowColor}">${dailyAvg.toFixed(1)}</td>
                        <td class="px-6 py-4 text-xs italic text-slate-500">${e.comments || '-'}</td>
                    </tr>
                `;
            });

            // 3. Overall Score Card
            const overallAvg = totalCount ? (totalSum/totalCount).toFixed(1) : "N/A";
            const scoreEl = document.getElementById('overallScoreDisplay');
            scoreEl.innerText = overallAvg;
            
            // Color Coding the Big Score
            scoreEl.className = "text-5xl font-black transition-colors duration-300"; // Reset
            if(overallAvg === "N/A") scoreEl.classList.add("text-slate-300");
            else if(overallAvg >= 3.5) scoreEl.classList.add("text-green-600");
            else if(overallAvg >= 2.5) scoreEl.classList.add("text-blue-600");
            else if(overallAvg >= 1.5) scoreEl.classList.add("text-yellow-600");
            else scoreEl.classList.add("text-red-600");

            updateCharts(skillSums, skillCounts, trendMap, distCounts, siteSums, siteCounts);
        }

        function updateCharts(sSums, sCounts, trendMap, dCounts, siteSums, siteCounts) {
            
            // 1. Skills Bar
            const sLabels = SKILLS;
            const sData = SKILLS.map(s => sCounts[s] ? (sSums[s]/sCounts[s]).toFixed(1) : 0);
            const sColors = sData.map(v => v>=3?'#16a34a': v>=2?'#2563eb': '#ea580c');

            if(charts.skills) charts.skills.destroy();
            charts.skills = new Chart(document.getElementById('skillsChart'), {
                type: 'bar',
                data: { labels: sLabels, datasets: [{ data: sData, backgroundColor: sColors, borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { min:0, max:4 } }, plugins: { legend: { display: false } } }
            });

            // 2. Trend Line
            // Sort dates chronologically
            const tLabels = Object.keys(trendMap).sort();
            const tData = tLabels.map(d => {
                const arr = trendMap[d];
                return (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
            });

            if(charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: { labels: tLabels, datasets: [{ data: tData, borderColor: '#4f46e5', backgroundColor: '#e0e7ff', fill: true, tension: 0.3 }] },
                options: { maintainAspectRatio: false, scales: { y: { min:0, max:4 } }, plugins: { legend: { display: false } } }
            });

            // 3. Distribution
            if(charts.dist) charts.dist.destroy();
            charts.dist = new Chart(document.getElementById('distributionChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Indep (4)', 'Verbal (3)', 'Model (2)', 'Phys (1)', 'Refusal (0)'],
                    datasets: [{
                        data: [dCounts[4], dCounts[3], dCounts[2], dCounts[1], dCounts[0]],
                        backgroundColor: ['#16a34a', '#2563eb', '#ca8a04', '#ea580c', '#dc2626'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // 4. Site Performance
            const siteLabels = Object.keys(siteSums);
            const siteData = siteLabels.map(s => (siteSums[s]/siteCounts[s]).toFixed(1));

            if(charts.site) charts.site.destroy();
            charts.site = new Chart(document.getElementById('siteChart'), {
                type: 'bar',
                data: { labels: siteLabels, datasets: [{ data: siteData, backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { min:0, max:4 } }, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
