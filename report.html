<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            /* Hide the modal during print unless you want it */
            #entryModal { display: none; }
        }
        /* Modal Transitions */
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans p-6">

    <div class="max-w-6xl mx-auto flex justify-between items-center mb-6 no-print">
        <h1 class="text-3xl font-bold text-gray-800">Vocational Reports</h1>
        <div class="space-x-4">
            <a href="home.html" class="text-indigo-600 hover:underline">Back to Dashboard</a>
        </div>
    </div>

    <div class="max-w-6xl mx-auto bg-white p-4 rounded shadow mb-6 no-print">
        <label class="font-bold mr-2">Select Student:</label>
        <select id="studentSelect" onchange="loadStudentData()" class="border p-2 rounded w-64">
            <option value="">Loading...</option>
        </select>
        <button onclick="window.print()" class="ml-4 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Print Summary</button>
    </div>

    <div id="reportContainer" class="max-w-6xl mx-auto bg-white p-8 rounded shadow hidden">
        
        <div class="flex justify-between items-end border-b pb-4 mb-6">
            <div>
                <h2 id="studentName" class="text-3xl font-bold text-indigo-900">Student Name</h2>
                <p class="text-gray-500">ID: <span id="studentIdDisplay">--</span></p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Overall Vocational Average</div>
                <div id="overallScore" class="text-4xl font-bold text-green-600">--</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold text-lg mb-4 text-center">Skill Breakdown (Average)</h3>
                <canvas id="skillsChart"></canvas>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold text-lg mb-4 text-center">Performance Over Time</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="print-break">
            <h3 class="font-bold text-xl mb-4 border-b pb-2">Session History</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b text-gray-600 uppercase">
                            <th class="p-3">Date</th>
                            <th class="p-3">Job Site</th>
                            <th class="p-3">Evaluator</th>
                            <th class="p-3">Avg Score</th>
                            <th class="p-3 w-1/3">Notes</th>
                            <th class="p-3 text-right no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <div>
                    <h3 class="text-xl font-bold text-indigo-900" id="modalDate">Date</h3>
                    <p class="text-sm text-gray-500" id="modalSite">Site</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-900 text-2xl font-bold">&times;</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="modalScores">
                </div>

            <div class="mt-6 bg-yellow-50 p-4 rounded border border-yellow-100">
                <h4 class="font-bold text-sm text-yellow-800 mb-1">Evaluator Notes:</h4>
                <p id="modalComments" class="text-gray-700 italic">No comments.</p>
            </div>

            <div class="mt-6 text-right">
                <button onclick="closeModal()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = localStorage.getItem('bresa_api_url');

        // THE 15 SKILLS
        const SKILLS = [
            "Punctual", "Prepared with Materials", "Hygiene/Dress", "Initiates Tasks", 
            "Work Rate", "Logical Order", "Adaptability", "Quality Standards", 
            "Awareness/Safety", "Social Interactions", "Communication", 
            "Constructive Criticism", "Positive Attitude", "Asks for Help", "Self-Reflection"
        ];

        let allEntries = [];
        let students = [];
        let currentStudentEntries = []; // Store filtered entries here for the modal to access
        let chartInstance = null;
        let trendInstance = null;

        async function init() {
            if(!API_URL) return alert("API Not Connected");
            
            // Fetch Data
            const sRes = await fetch(API_URL + "?action=getStudents");
            const sData = await sRes.json();
            students = sData.data;
            
            const sel = document.getElementById('studentSelect');
            sel.innerHTML = '<option value="">Select a Student...</option>';
            students.forEach(s => {
                sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
            });

            const eRes = await fetch(API_URL + "?action=getEntries");
            const eData = await eRes.json();
            allEntries = eData.data;
        }

        function loadStudentData() {
            const sid = document.getElementById('studentSelect').value;
            if(!sid) { document.getElementById('reportContainer').classList.add('hidden'); return; }

            const student = students.find(s => s.student_id == sid);
            document.getElementById('studentName').innerText = student.name;
            document.getElementById('studentIdDisplay').innerText = student.student_id;
            document.getElementById('reportContainer').classList.remove('hidden');

            // Filter entries for this student
            currentStudentEntries = allEntries.filter(e => e.student_id == sid);
            
            // Calculate Stats
            let totalSum = 0;
            let totalCount = 0;
            let sums = new Array(15).fill(0);
            let counts = new Array(15).fill(0);

            currentStudentEntries.forEach(entry => {
                entry.scores.forEach((score, idx) => {
                    if(score !== "" && score !== null) {
                        sums[idx] += Number(score);
                        counts[idx]++;
                        totalSum += Number(score);
                        totalCount++;
                    }
                });
            });

            const averages = sums.map((s, i) => counts[i] ? (s / counts[i]).toFixed(1) : 0);
            const overall = totalCount ? (totalSum / totalCount).toFixed(2) : "N/A";

            document.getElementById('overallScore').innerText = overall;

            renderCharts(averages, currentStudentEntries);
            renderTable(currentStudentEntries);
        }

        function renderCharts(averages, entries) {
            const ctx1 = document.getElementById('skillsChart');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx1, {
                type: 'radar',
                data: {
                    labels: SKILLS,
                    datasets: [{
                        label: 'Average Score',
                        data: averages,
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: '#4F46E5',
                        borderWidth: 2,
                        pointBackgroundColor: '#4F46E5'
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 4, ticks: { stepSize: 1 } } }
                }
            });

            const ctx2 = document.getElementById('trendChart');
            if(trendInstance) trendInstance.destroy();

            // Sort by date for the line chart
            const sortedEntries = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
            const dates = sortedEntries.map(e => new Date(e.date).toLocaleDateString());
            const dailyAvgs = sortedEntries.map(e => {
                let s = 0, c = 0;
                e.scores.forEach(v => { if(v!=="") { s+=Number(v); c++; }});
                return c ? (s/c).toFixed(1) : 0;
            });

            trendInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Average',
                        data: dailyAvgs,
                        borderColor: '#10B981',
                        backgroundColor: '#D1FAE5',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { scales: { y: { min: 0, max: 4 } } }
            });
        }

        function renderTable(entries) {
            const tbody = document.getElementById('entriesTable');
            tbody.innerHTML = '';
            
            // Sort Newest First for the table
            const sorted = [...entries].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach((e, index) => {
                let s = 0, c = 0;
                e.scores.forEach(v => { if(v!=="") { s+=Number(v); c++; }});
                const avg = c ? (s/c).toFixed(1) : "-";
                
                // Color code the average
                let avgColor = "text-gray-600";
                if(avg >= 3) avgColor = "text-green-600 font-bold";
                else if(avg >= 2) avgColor = "text-yellow-600 font-bold";
                else if(avg > 0) avgColor = "text-red-600 font-bold";

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-3 text-gray-800">${new Date(e.date).toLocaleDateString()}</td>
                        <td class="p-3 font-medium text-indigo-900">${e.job_site || "N/A"}</td>
                        <td class="p-3 text-gray-500 text-sm">${e.evaluator}</td>
                        <td class="p-3 ${avgColor}">${avg}</td>
                        <td class="p-3 text-gray-500 italic text-sm truncate max-w-xs">${e.comments}</td>
                        <td class="p-3 text-right no-print">
                            <button onclick="openModal(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-200">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- MODAL FUNCTIONS ---

        function openModal(index) {
            // Because we sorted the table by Newest First, we need to grab from the sorted array
            const sortedEntries = [...currentStudentEntries].sort((a,b) => new Date(b.date) - new Date(a.date));
            const entry = sortedEntries[index];

            document.getElementById('modalDate').innerText = new Date(entry.date).toLocaleDateString();
            document.getElementById('modalSite').innerText = entry.job_site + " (Evaluator: " + entry.evaluator + ")";
            document.getElementById('modalComments').innerText = entry.comments || "No comments provided.";

            const grid = document.getElementById('modalScores');
            grid.innerHTML = '';

            SKILLS.forEach((skill, i) => {
                const score = entry.scores[i];
                let colorClass = "bg-gray-100 text-gray-400"; // Default for empty
                let scoreText = "-";

                if (score !== "" && score !== null) {
                    scoreText = score;
                    // Color Logic
                    if (score == 4) colorClass = "bg-green-100 text-green-800 border-green-200";
                    else if (score == 3) colorClass = "bg-green-50 text-green-700 border-green-100";
                    else if (score == 2) colorClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    else if (score <= 1) colorClass = "bg-red-100 text-red-800 border-red-200";
                }

                grid.innerHTML += `
                    <div class="flex justify-between items-center p-2 rounded border ${colorClass}">
                        <span class="text-sm font-medium truncate pr-2">${skill}</span>
                        <span class="font-bold text-lg">${scoreText}</span>
                    </div>
                `;
            });

            document.getElementById('entryModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('entryModal').classList.add('hidden');
        }

        // Close modal if clicking outside the box
        window.onclick = function(event) {
            const modal = document.getElementById('entryModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        init();
    </script>
</body>
</html>
