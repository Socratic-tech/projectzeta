<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vocational Report Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #F3F4F6; }
        @media print {
            @page { margin: 0.5in; size: portrait; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            #reportContainer { box-shadow: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; display: block !important; }
            #chartContainer { height: 350px !important; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 20px; }
            #skillsGrid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 10px !important; }
            .history-section { page-break-before: always; }
        }
    </style>
</head>
<body class="text-gray-900 font-sans pb-10">

    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50 no-print">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96 text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Login Required</h2>
            <div id="connectWarning" class="hidden bg-red-100 text-red-700 p-3 rounded text-sm mb-4">
                System not connected. Please go to <strong>Admin</strong> to set up.
            </div>
            <input type="password" id="authInput" class="w-full border p-3 rounded mb-4 text-center text-xl tracking-widest" placeholder="Enter PIN">
            <button id="loginBtn" onclick="attemptLogin()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700 transition">Unlock System</button>
            <p id="authError" class="text-red-500 text-sm mt-3 hidden">Incorrect PIN.</p>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <nav class="bg-white shadow border-b border-gray-200 mb-6 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <a href="index.html" class="flex items-center text-gray-500 hover:text-indigo-600 mr-4">
                            <span class="material-icons">arrow_back</span>
                        </a>
                        <h1 class="text-xl font-bold text-indigo-600">Reports</h1>
                    </div>
                    <div class="flex items-center"><button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm font-medium">Logout</button></div>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto bg-white p-5 rounded-lg shadow mb-6 no-print border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Student</label><select id="studentSelect" onchange="loadStudentData()" class="w-full border p-2 rounded bg-gray-50"><option value="">Select Student...</option></select></div>
                <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Start Date</label><input type="date" id="startDate" onchange="loadStudentData()" class="w-full border p-2 rounded"></div>
                <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">End Date</label><input type="date" id="endDate" onchange="loadStudentData()" class="w-full border p-2 rounded"></div>
                <div><label class="block text-xs font-bold uppercase text-gray-500 mb-1">Job Site</label><select id="siteFilter" onchange="loadStudentData()" class="w-full border p-2 rounded"><option value="All">All Sites</option></select></div>
            </div>
            <div class="mt-4 pt-4 border-t flex justify-end">
                <button onclick="window.print()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-bold shadow flex items-center gap-2">Print Report Card</button>
            </div>
        </div>

        <div id="reportContainer" class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg hidden min-h-screen relative">
            <div class="flex justify-between items-start border-b-4 border-indigo-600 pb-4 mb-6">
                <div><h2 id="studentName" class="text-4xl font-bold text-gray-900">Student Name</h2><div class="mt-2 text-gray-600"><p><strong>Report Period:</strong> <span id="dateRangeDisplay">--</span></p><p><strong>Job Site Filter:</strong> <span id="siteDisplay">All</span></p></div></div>
                <div class="text-right bg-gray-50 p-4 rounded-lg border border-gray-200"><div class="text-xs text-gray-500 uppercase tracking-wide font-bold mb-1">Overall Average</div><div id="overallScore" class="text-5xl font-bold text-gray-800 leading-none">--</div><div class="text-xs text-gray-400 mt-1">Scale: 0.0 - 4.0</div></div>
            </div>
            <div id="chartContainer" class="mb-8 h-80 relative"><canvas id="skillsChart"></canvas></div>
            <h3 class="font-bold text-lg mb-3 text-gray-800 uppercase tracking-wider border-b border-gray-300 pb-1">Detailed Skill Breakdown</h3>
            <div id="skillsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
            <div class="history-section pt-4">
                <h3 class="font-bold text-lg mb-4 text-gray-800 uppercase tracking-wider border-b border-gray-300 pb-1">Evaluation History</h3>
                <div class="overflow-x-auto mb-8"><table class="w-full text-left text-sm border-collapse"><thead><tr class="bg-gray-100 border-b-2 border-gray-300 text-gray-600 uppercase text-xs"><th class="p-3">Date</th><th class="p-3">Job Site</th><th class="p-3">Evaluator</th><th class="p-3 text-center">Score</th><th class="p-3 w-1/3">Notes</th></tr></thead><tbody id="entriesTable" class="divide-y divide-gray-200"></tbody></table></div>
                <div class="signature-section mt-16 pt-8 grid grid-cols-2 gap-16"><div><div class="border-b-2 border-gray-400 mb-2"></div><p class="text-sm font-bold text-gray-600 uppercase tracking-wide">Teacher of Record</p></div><div><div class="border-b-2 border-gray-400 mb-2"></div><p class="text-sm font-bold text-gray-600 uppercase tracking-wide">Employer / Supervisor</p></div></div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = localStorage.getItem('bresa_api_url');
        const SKILLS = ["Punctual", "Prepared", "Hygiene/Dress", "Task Initiation", "Work Rate", "Logical Order", "Adaptability", "Quality Standards", "Clean Workspace", "Awareness/Safety", "Social Interactions", "Communication", "Constructive Criticism", "Positive Attitude", "Asks for Help", "Self-Reflection"];
        let allEntries=[], students=[], filteredEntries=[], chartInstance=null;

        function checkAuth() {
            if(!API_URL) { document.getElementById('connectWarning').classList.remove('hidden'); document.getElementById('loginBtn').disabled=true; return; }
            if (sessionStorage.getItem('auth') === 'true') {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                init();
            }
        }
        async function attemptLogin() {
            const input = document.getElementById('authInput').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('authError');
            btn.disabled = true; btn.innerText = "Verifying..."; err.classList.add('hidden');
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "verifyPassword", password: input }) });
                const data = await res.json();
                if (data.status === "success") { sessionStorage.setItem('auth', 'true'); checkAuth(); } 
                else { err.classList.remove('hidden'); btn.disabled = false; btn.innerText = "Unlock System"; }
            } catch (e) { alert("Connection Error"); btn.disabled = false; btn.innerText = "Unlock System"; }
        }
        function logout() { sessionStorage.removeItem('auth'); window.location.reload(); }
        document.getElementById('authInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') attemptLogin(); });

        async function init() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = firstDay;
            try {
                const sRes = await fetch(API_URL + "?action=getStudents");
                const sData = await sRes.json();
                students = sData.data;
                const sel = document.getElementById('studentSelect');
                sel.innerHTML = '<option value="">Select a Student...</option>';
                students.forEach(s => sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`);

                const jRes = await fetch(API_URL + "?action=getJobSites");
                const jData = await jRes.json();
                const siteSel = document.getElementById('siteFilter');
                siteSel.innerHTML = '<option value="All">All Sites</option>';
                if(jData.data) jData.data.forEach(s => siteSel.innerHTML += `<option value="${s}">${s}</option>`);

                const eRes = await fetch(API_URL + "?action=getEntries");
                const eData = await eRes.json();
                allEntries = eData.data;
            } catch(e) { console.error(e); }
        }

        function loadStudentData() {
            // (Same reporting logic as previous version, omitted for brevity, it is compatible)
            // Copy logic from previous report.html: loadStudentData, renderBarChart, renderGrid, renderTable
            const sid = document.getElementById('studentSelect').value;
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const siteFilter = document.getElementById('siteFilter').value;
            if(!sid) { document.getElementById('reportContainer').classList.add('hidden'); return; }
            const student = students.find(s => s.student_id == sid);
            document.getElementById('studentName').innerText = student.name;
            document.getElementById('dateRangeDisplay').innerText = `${new Date(startStr).toLocaleDateString()} - ${new Date(endStr).toLocaleDateString()}`;
            document.getElementById('siteDisplay').innerText = siteFilter;
            document.getElementById('reportContainer').classList.remove('hidden');
            const startDate = new Date(startStr); const endDate = new Date(endStr); endDate.setHours(23,59,59);
            filteredEntries = allEntries.filter(e => {
                const eDate = new Date(e.date);
                return e.student_id == sid && eDate >= startDate && eDate <= endDate && (siteFilter === "All" || e.job_site === siteFilter);
            });
            filteredEntries.sort((a,b) => new Date(b.date) - new Date(a.date));
            let sums = new Array(16).fill(0), counts = new Array(16).fill(0), grandSum = 0, grandCount = 0;
            filteredEntries.forEach(entry => { entry.scores.forEach((score, idx) => { if(score !== "" && score !== null) { const num = Number(score); sums[idx] += num; counts[idx]++; grandSum += num; grandCount++; } }); });
            const averages = sums.map((s, i) => counts[i] ? (s / counts[i]).toFixed(1) : 0);
            const overall = grandCount ? (grandSum / grandCount).toFixed(2) : "N/A";
            const ovDiv = document.getElementById('overallScore');
            ovDiv.innerText = overall;
            ovDiv.className = "text-5xl font-bold leading-none " + (overall >= 3 ? "text-green-600" : (overall >= 2 ? "text-yellow-600" : "text-red-600"));
            renderBarChart(averages); renderGrid(averages, counts); renderTable(filteredEntries);
        }
        function renderBarChart(averages) {
            const ctx = document.getElementById('skillsChart'); if(chartInstance) chartInstance.destroy();
            const bgColors = averages.map(s => s >= 3.0 ? '#10B981' : (s >= 2.0 ? '#F59E0B' : '#EF4444'));
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: SKILLS, datasets: [{ label: 'Avg', data: averages, backgroundColor: bgColors, borderRadius: 4 }] }, options: { indexAxis: 'y', maintainAspectRatio: false, scales: { x: { min: 0, max: 4 } }, plugins: { legend: { display: false } } } });
        }
        function renderGrid(avgs, counts) {
            const grid = document.getElementById('skillsGrid'); grid.innerHTML = '';
            SKILLS.forEach((skill, i) => { let c = counts[i] > 0 ? (avgs[i]>=3?"bg-green-50 text-green-800":(avgs[i]>=2?"bg-yellow-50 text-yellow-800":"bg-red-50 text-red-800")) : "bg-gray-50"; grid.innerHTML += `<div class="border rounded p-3 flex flex-col justify-between ${c}"><span class="text-xs font-bold uppercase">${skill}</span><div class="mt-2 flex justify-between"><span class="text-2xl font-bold">${avgs[i]}</span><span class="text-[10px]">${counts[i]} logs</span></div></div>`; });
        }
        function renderTable(entries) {
            const tbody = document.getElementById('entriesTable'); tbody.innerHTML = '';
            if(entries.length === 0) return tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">No records found.</td></tr>';
            entries.forEach((e) => { let s=0,c=0; e.scores.forEach(v=>{if(v!==""){s+=Number(v);c++;}}); const avg=c?(s/c).toFixed(1):"-"; tbody.innerHTML += `<tr class="border-b"><td class="p-3">${new Date(e.date).toLocaleDateString()}</td><td class="p-3">${e.job_site||"-"}</td><td class="p-3">${e.evaluator}</td><td class="p-3 text-center font-bold">${avg}</td><td class="p-3 text-sm italic">${e.comments}</td></tr>`; });
        }
        checkAuth();
    </script>
</body>
</html>
