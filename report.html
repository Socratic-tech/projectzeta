<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocational Progress Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- SCREEN STYLES (App Layout) --- */
        body { 
            background-color: #f1f5f9; 
            color: #0f172a; 
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Hides signature on screen */
        .signature-section { display: none; }
        #printHistoryTable { display: none; }

        /* --- PRINT STYLES --- */
        @media print {
            body, #mainLayout, #contentArea {
                height: auto !important;
                overflow: visible !important;
                display: block !important;
                background: white !important;
                position: static !important;
            }
            nav, #sidebarCol, .no-print, button, #loadingIndicator, select {
                display: none !important;
            }
            #contentArea {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }
            #summaryView, #detailView {
                max-width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            /* Grid layout for print charts */
            .charts-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
                page-break-inside: avoid;
            }
            .chart-card {
                height: 200px !important; /* Smaller charts for print */
                border: 1px solid #ccc;
                box-shadow: none !important;
                page-break-inside: avoid;
            }
            
            #printHistoryTable {
                display: block !important;
                width: 100%;
                margin-top: 2rem;
                page-break-before: auto;
            }
            .signature-section {
                display: flex !important;
                justify-content: space-between;
                margin-top: 40px;
                padding-top: 10px;
                page-break-inside: avoid;
            }
            table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            th, td { border: 1px solid #94a3b8; padding: 6px; text-align: left; }
            th { background-color: #e2e8f0 !important; -webkit-print-color-adjust: exact; font-weight: bold; }
        }
    </style>
</head>
<body>

    <nav class="bg-blue-900 text-white shadow-lg shrink-0 z-10">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-yellow-400">analytics</span>
                    <span class="font-bold text-xl">Vocational Reports</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">assignment</span> Entry
                    </a>
                    <a href="admin.html" class="hover:bg-blue-800 px-3 py-2 rounded transition flex items-center gap-1 text-sm font-medium">
                        <span class="material-icons text-sm">settings</span> Admin
                    </a>
                    <button onclick="window.print()" class="bg-white text-blue-900 font-bold px-4 py-2 rounded hover:bg-blue-50 transition flex items-center gap-1 text-sm shadow">
                        <span class="material-icons text-sm">print</span> Print Report
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="loadingIndicator" class="fixed inset-0 bg-slate-100 z-50 flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-medium">Loading Database...</p>
    </div>

    <div id="mainLayout" class="hidden flex-1 flex overflow-hidden">
        
        <div id="sidebarCol" class="w-80 bg-white border-r border-slate-200 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-slate-200 bg-slate-50">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Student</label>
                <select id="studentSelect" onchange="loadStudentData()" class="w-full p-2 border rounded text-sm bg-white outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Choose --</option>
                </select>
            </div>
            
            <div class="p-3 bg-slate-100 border-b border-slate-200 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase">Visit History</span>
                    <span id="visitCount" class="text-xs bg-slate-300 px-2 py-0.5 rounded-full text-slate-700">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-[10px] uppercase font-bold text-slate-400">Sort:</label>
                    <select id="sortOrder" onchange="renderVisitList()" class="flex-1 text-xs p-1 border rounded bg-white">
                        <option value="date">Date (Newest)</option>
                        <option value="site">Job Site (A-Z)</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-2" id="visitList">
                <div class="text-center text-slate-400 text-sm mt-10 italic">Select a student...</div>
            </div>
        </div>

        <div id="contentArea" class="flex-1 overflow-y-auto custom-scroll bg-slate-50 p-6 md:p-8">
            
            <div id="summaryView" class="hidden max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800" id="summaryTitle">Overview</h1>
                        <p class="text-slate-500 text-sm">Vocational Skills Dashboard</p>
                    </div>
                    <select id="timeRange" onchange="renderSummary()" class="p-2 border rounded text-sm bg-white shadow-sm no-print">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="all">All Time</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs text-slate-500 font-bold uppercase">Average Score</p>
                        <p id="avgScore" class="text-2xl font-bold text-slate-800">0.0</p>
                    </div>
                    <div class="card bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-xs text-slate-500 font-bold uppercase">Strongest Skill</p>
                        <p id="topSkill" class="text-md font-bold text-slate-800 leading-tight">N/A</p>
                    </div>
                    <div class="card bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <p class="text-xs text-slate-500 font-bold uppercase">Evaluations</p>
                        <p id="totalEvals" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 charts-grid">
                    
                    <div class="card chart-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-80">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Skills Profile</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="skillsChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-80">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Progress Over Time</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-80">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Support Level Breakdown</h3>
                        <div class="relative h-64 w-full flex justify-center">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-80">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Performance by Job Site</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="siteChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="printHistoryTable">
                    <h3 class="text-lg font-bold mb-2 text-slate-800 border-b pb-1">Detailed Log</h3>
                    <table>
                        <thead>
                            <tr>
                                <th class="w-24">Date</th>
                                <th>Job Site</th>
                                <th>Evaluator</th>
                                <th class="w-16">Avg</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="printHistoryBody"></tbody>
                    </table>
                </div>

                <div class="signature-section">
                    <div class="w-5/12">
                        <div class="border-b-2 border-slate-400 mb-2"></div>
                        <p class="text-sm font-bold text-slate-700">Teacher Signature</p>
                    </div>
                    <div class="w-5/12">
                        <div class="border-b-2 border-slate-400 mb-2"></div>
                        <p class="text-sm font-bold text-slate-700">Supervisor Signature</p>
                    </div>
                </div>
            </div>

            <div id="detailView" class="hidden max-w-4xl mx-auto">
                <div class="mb-6 flex justify-between items-start no-print">
                    <button onclick="showSummary()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 mb-2">
                        <span class="material-icons text-sm">arrow_back</span> Back to Overview
                    </button>
                </div>

                <div class="card bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-800 text-white p-6 flex justify-between items-center print:bg-slate-200 print:text-black">
                        <div>
                            <h2 class="text-2xl font-bold" id="detailDate">Date</h2>
                            <p class="text-slate-400 flex items-center gap-2 mt-1 print:text-slate-600">
                                <span class="material-icons text-sm">work</span> <span id="detailSite">Site</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs uppercase text-slate-400 print:text-slate-600">Evaluator</div>
                            <div class="font-bold text-lg" id="detailEvaluator">Name</div>
                        </div>
                    </div>

                    <div class="p-6 bg-slate-50 border-b border-slate-200 print:bg-white">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Skill Performance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="detailScores"></div>
                    </div>

                    <div class="p-6">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Evaluator Notes</h3>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-slate-700 italic print:bg-white print:border-slate-300">
                            <span class="material-icons text-yellow-400 text-sm align-middle mr-1 no-print">format_quote</span>
                            <span id="detailComments">No comments.</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const SKILLS = [
            "Punctual", "Prepared with Necessary Materials", "Demonstrates appropriate hygiene/dress",
            "Initiates familiar tasks", "Maintains a productive work rate", "Complete tasks in a logical order",
            "Demonstrates adaptability", "Work is completed to quality standards", "Maintains clean and organized work space",
            "Awareness of surroundings and good decision making", "Appropriate and respectful social interactions",
            "Displays effective communication skills", "Accepts constructive criticism", "Demonstrates a positive attitude",
            "Asks for help appropriately", "Demonstrates self-reflection"
        ];

        const SCORES_DEF = {
            4: { label: "Independent", color: "text-green-600", bg: "bg-green-100", border: "border-green-200", hex: "#16a34a" },
            3: { label: "Verbal Prompts", color: "text-blue-600", bg: "bg-blue-100", border: "border-blue-200", hex: "#2563eb" },
            2: { label: "Modeling", color: "text-yellow-600", bg: "bg-yellow-100", border: "border-yellow-200", hex: "#ca8a04" },
            1: { label: "Physical Assist", color: "text-orange-600", bg: "bg-orange-100", border: "border-orange-200", hex: "#ea580c" },
            0: { label: "Refusal", color: "text-red-600", bg: "bg-red-100", border: "border-red-200", hex: "#dc2626" }
        };

        let allEntries = [], currentEntries = [], students = {};
        // Chart instances
        let skillsChart = null, trendChart = null, distChart = null, siteChart = null;

        function parseDate(d) {
            if(!d) return new Date();
            const p = d.substring(0,10).split('-');
            return new Date(p[0], p[1]-1, p[2]);
        }
        function fmtDate(d) { return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}); }

        window.onload = async () => {
            const url = localStorage.getItem('vocational_backend_url');
            if(!url) return alert("No Database Connected");

            try {
                const t = Date.now();
                const [sRes, eRes] = await Promise.all([
                    fetch(`${url}?action=getStudents&t=${t}`), fetch(`${url}?action=getEntries&t=${t}`)
                ]);
                const sD = await sRes.json();
                const eD = await eRes.json();

                const sel = document.getElementById('studentSelect');
                sD.data.forEach(s => {
                    students[s.student_id] = s.name;
                    sel.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                });
                allEntries = eD.data;
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('mainLayout').classList.remove('hidden');
            } catch(e) { console.error(e); alert("Connection Error"); }
        };

        function loadStudentData() {
            const sid = document.getElementById('studentSelect').value;
            const list = document.getElementById('visitList');
            if(!sid) {
                document.getElementById('summaryView').classList.add('hidden');
                document.getElementById('detailView').classList.add('hidden');
                list.innerHTML = "<div class='text-center text-slate-400 mt-10'>Select Student</div>";
                document.getElementById('visitCount').innerText = "0";
                return;
            }

            currentEntries = allEntries.filter(e => e.student_id == sid);
            document.getElementById('visitCount').innerText = currentEntries.length;
            renderVisitList();
            showSummary();
        }

        function renderVisitList() {
            const list = document.getElementById('visitList');
            const sortMode = document.getElementById('sortOrder').value;

            currentEntries.sort((a, b) => {
                if (sortMode === 'date') return parseDate(b.date) - parseDate(a.date);
                const siteComp = a.job_site.localeCompare(b.job_site);
                return siteComp !== 0 ? siteComp : parseDate(b.date) - parseDate(a.date);
            });

            let html = `<div onclick="showSummary()" class="cursor-pointer p-3 rounded-lg border border-blue-200 bg-blue-50 hover:bg-blue-100 mb-4 font-bold text-blue-700 flex gap-2"><span class="material-icons text-sm">dashboard</span> Overview</div>`;
            
            if(currentEntries.length === 0) html += "<div class='text-center text-slate-400'>No visits found.</div>";

            currentEntries.forEach((e, i) => {
                const d = parseDate(e.date);
                html += `<div onclick="showDetail(${i})" class="cursor-pointer p-3 rounded-lg border border-slate-200 bg-white hover:border-blue-400 mb-2 shadow-sm">
                        <div class="flex justify-between font-bold text-sm text-slate-700">
                            <span>${d.toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'2-digit'})}</span>
                            <span class="text-[10px] uppercase text-slate-400">${e.job_site.substring(0,12)}</span>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">${e.evaluator}</div>
                    </div>`;
            });
            list.innerHTML = html;
        }

        function showSummary() {
            document.getElementById('detailView').classList.add('hidden');
            document.getElementById('summaryView').classList.remove('hidden');
            renderSummary();
        }

        function renderSummary() {
            const range = document.getElementById('timeRange').value;
            const sid = document.getElementById('studentSelect').value;
            document.getElementById('summaryTitle').innerText = students[sid];

            const now = new Date(); now.setHours(0,0,0,0);
            const cutoff = new Date(now);
            if(range !== 'all') cutoff.setDate(now.getDate() - parseInt(range));

            // Filter data by date
            const filtered = currentEntries.filter(e => parseDate(e.date) >= cutoff);
            
            // --- DATA PREPARATION ---
            
            // 1. Skill Sums (Existing)
            let skillSums = {}, skillCounts = {}, totalSum = 0, totalCount = 0;
            SKILLS.forEach(s => { skillSums[s]=0; skillCounts[s]=0; });

            // 2. Trend Data (Date -> Avg)
            let trendMap = {}; // Use map to handle multiple entries on same day

            // 3. Distribution Counts (0-4)
            let distCounts = {0:0, 1:0, 2:0, 3:0, 4:0};

            // 4. Site Data
            let siteSums = {}, siteCounts = {};

            // Print Table Body
            const printBody = document.getElementById('printHistoryBody');
            printBody.innerHTML = "";
            const printEntries = [...filtered].sort((a,b) => parseDate(b.date) - parseDate(a.date));

            if(printEntries.length === 0) printBody.innerHTML = "<tr><td colspan='5' class='text-center italic'>No records.</td></tr>";

            printEntries.forEach(e => {
                let daySum = 0, dayCount = 0;
                
                // Track Site
                if(!siteSums[e.job_site]) { siteSums[e.job_site]=0; siteCounts[e.job_site]=0; }

                SKILLS.forEach(s => {
                    const val = parseFloat(e.scores[s]);
                    if(!isNaN(val)) {
                        // Skill totals
                        skillSums[s] += val; skillCounts[s]++;
                        totalSum += val; totalCount++;
                        // Day totals
                        daySum += val; dayCount++;
                        // Distribution
                        distCounts[val]++;
                    }
                });

                const dailyAvg = dayCount ? (daySum/dayCount) : 0;
                
                // Add to Trend (Key by date)
                const dateKey = fmtDate(parseDate(e.date));
                if(!trendMap[dateKey]) trendMap[dateKey] = [];
                trendMap[dateKey].push(dailyAvg);

                // Add to Site
                siteSums[e.job_site] += dailyAvg; 
                siteCounts[e.job_site]++;

                // Add to Table
                printBody.innerHTML += `<tr><td>${dateKey}</td><td>${e.job_site}</td><td>${e.evaluator}</td><td>${dailyAvg.toFixed(1)}</td><td class="text-xs italic text-slate-600">${e.comments ? e.comments.substring(0,60) : '-'}</td></tr>`;
            });

            // Update Cards
            document.getElementById('totalEvals').innerText = filtered.length;
            document.getElementById('avgScore').innerText = totalCount ? (totalSum/totalCount).toFixed(1) : "0.0";
            
            let bestAvg = -1, bestName = "N/A";
            SKILLS.forEach(s => {
                const avg = skillCounts[s] ? (skillSums[s]/skillCounts[s]) : 0;
                if(avg > bestAvg && avg > 0) { bestAvg = avg; bestName = s; }
            });
            document.getElementById('topSkill').innerText = bestName;

            // --- CHARTS ---

            // 1. Skills Bar Chart
            const ctx1 = document.getElementById('skillsChart').getContext('2d');
            if(skillsChart) skillsChart.destroy();
            const skillsData = SKILLS.map(s => skillCounts[s] ? (skillSums[s]/skillCounts[s]).toFixed(1) : 0);
            const skillsBg = skillsData.map(v => v>=3.5?'#16a34a': v>=2.5?'#2563eb': v>=1.5?'#ca8a04':'#dc2626');
            
            skillsChart = new Chart(ctx1, {
                type: 'bar',
                data: { labels: SKILLS, datasets: [{ data: skillsData, backgroundColor: skillsBg, borderRadius: 4 }] },
                options: { 
                    indexAxis: 'y', maintainAspectRatio: false,
                    scales: { x: { min:0, max:4 }, y: { ticks: { font: {size:9} } } },
                    plugins: { legend: { display: false } }
                }
            });

            // 2. Trend Line Chart
            const ctx2 = document.getElementById('trendChart').getContext('2d');
            if(trendChart) trendChart.destroy();
            // Process Trend Map into arrays
            // Sort dates chronologically
            const sortedDates = Object.keys(trendMap).sort((a,b) => new Date(a) - new Date(b)); 
            // Calculate avg if multiple entries per day
            const trendValues = sortedDates.map(d => {
                const vals = trendMap[d];
                return (vals.reduce((a,b)=>a+b,0) / vals.length).toFixed(1);
            });

            trendChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Avg',
                        data: trendValues,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 4 } },
                    plugins: { legend: { display: false } }
                }
            });

            // 3. Distribution Doughnut
            const ctx3 = document.getElementById('distributionChart').getContext('2d');
            if(distChart) distChart.destroy();
            distChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: ['Independent (4)', 'Verbal (3)', 'Modeling (2)', 'Physical (1)', 'Refusal (0)'],
                    datasets: [{
                        data: [distCounts[4], distCounts[3], distCounts[2], distCounts[1], distCounts[0]],
                        backgroundColor: ['#16a34a', '#2563eb', '#ca8a04', '#ea580c', '#dc2626'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } }
                }
            });

            // 4. Site Performance Bar
            const ctx4 = document.getElementById('siteChart').getContext('2d');
            if(siteChart) siteChart.destroy();
            const sites = Object.keys(siteSums);
            const siteAvgs = sites.map(s => (siteSums[s] / siteCounts[s]).toFixed(1));

            siteChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: sites,
                    datasets: [{
                        data: siteAvgs,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 4 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showDetail(i) {
            const e = currentEntries[i];
            document.getElementById('summaryView').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');

            document.getElementById('detailDate').innerText = fmtDate(parseDate(e.date));
            document.getElementById('detailSite').innerText = e.job_site;
            document.getElementById('detailEvaluator').innerText = e.evaluator;
            document.getElementById('detailComments').innerText = e.comments || "No comments.";

            const grid = document.getElementById('detailScores');
            grid.innerHTML = "";
            SKILLS.forEach(s => {
                const val = parseInt(e.scores[s]);
                const def = SCORES_DEF[val] || {label:"N/A", color:"text-gray-400", bg:"bg-gray-50", border:"border-gray-200"};
                grid.innerHTML += `
                    <div class="flex items-center justify-between p-3 rounded border ${def.bg} ${def.border}">
                        <div class="text-sm font-medium text-slate-700 w-2/3">${s}</div>
                        <div class="text-right">
                            <span class="block text-xl font-bold ${def.color}">${isNaN(val)?'-':val}</span>
                            <span class="text-[10px] uppercase font-bold text-slate-500">${def.label}</span>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
